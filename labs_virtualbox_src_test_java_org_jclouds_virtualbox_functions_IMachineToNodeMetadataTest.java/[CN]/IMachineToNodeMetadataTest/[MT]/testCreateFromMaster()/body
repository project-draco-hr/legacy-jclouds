{
  IMachine vm=createNiceMock(IMachine.class);
  expect(vm.getName()).andReturn(VIRTUALBOX_IMAGE_PREFIX + MASTER_NAME).anyTimes();
  expect(vm.getState()).andReturn(MachineState.PoweredOff).anyTimes();
  INetworkAdapter nat=createNiceMock(INetworkAdapter.class);
  INATEngine natEng=createNiceMock(INATEngine.class);
  expect(vm.getNetworkAdapter(eq(0l))).andReturn(nat).once();
  expect(vm.getNetworkAdapter(eq(1l))).andReturn(null).once();
  expect(nat.getAttachmentType()).andReturn(NetworkAttachmentType.NAT).once();
  expect(nat.getNatDriver()).andReturn(natEng).anyTimes();
  expect(natEng.getHostIP()).andReturn("127.0.0.1").once();
  expect(natEng.getRedirects()).andReturn(ImmutableList.of("0,1,127.0.0.1,2222,,22"));
  INetworkAdapter hostOnly=createNiceMock(INetworkAdapter.class);
  MachineUtils machineUtils=createNiceMock(MachineUtils.class);
  replay(vm,nat,natEng,hostOnly,machineUtils);
  NodeMetadata node=new IMachineToNodeMetadata(machineUtils).apply(vm);
  assertEquals(MASTER_NAME,node.getName());
  assertEquals(0,node.getPrivateAddresses().size());
  assertEquals(1,node.getPublicAddresses().size());
  assertEquals("127.0.0.1",Iterables.get(node.getPublicAddresses(),0));
  assertEquals(MastersLoadingCache.MASTER_PORT,node.getLoginPort());
  assertEquals("",node.getGroup());
}
