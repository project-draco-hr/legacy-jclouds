{
  String httpMethod=getHttpMethodOrConstantOrThrowException(method);
  UriBuilder builder=addHostPrefixIfPresent(endpoint,method,args);
  builder.path(declaring);
  builder.path(method);
  if (declaring.isAnnotationPresent(Query.class)) {
    Query query=declaring.getAnnotation(Query.class);
    addQuery(builder,query);
  }
  if (method.isAnnotationPresent(Query.class)) {
    Query query=method.getAnnotation(Query.class);
    addQuery(builder,query);
  }
  Multimap<String,String> headers=buildHeaders(method,args);
  HttpRequestOptions options=findOptionsIn(method,args);
  if (options != null) {
    headers.putAll(options.buildRequestHeaders());
    for (    Entry<String,String> query : options.buildQueryParameters().entries()) {
      builder.queryParam(query.getKey(),query.getValue());
    }
    for (    Entry<String,String> matrix : options.buildMatrixParameters().entries()) {
      builder.matrixParam(matrix.getKey(),matrix.getValue());
    }
    String pathSuffix=options.buildPathSuffix();
    if (pathSuffix != null) {
      builder.path(pathSuffix);
    }
  }
  URI endPoint;
  try {
    addHeaderIfAnnotationPresentOnMethod(headers,method,args);
    if (declaring.isAnnotationPresent(SkipEncoding.class)) {
      endPoint=builder.buildFromEncodedMap(getEncodedPathParamKeyValues(method,args,declaring.getAnnotation(SkipEncoding.class).value()));
    }
 else {
      endPoint=builder.buildFromEncodedMap(getEncodedPathParamKeyValues(method,args));
    }
  }
 catch (  Exception e) {
    throw new IllegalStateException("problem encoding parameters",e);
  }
  HttpRequest request=new HttpRequest(httpMethod,endPoint,headers);
  addHostHeaderIfAnnotatedWithVirtualHost(headers,request.getEndpoint().getHost(),method);
  addFiltersIfAnnotated(method,request);
  buildEntityIfPostOrPutRequest(method,args,request);
  return request;
}
