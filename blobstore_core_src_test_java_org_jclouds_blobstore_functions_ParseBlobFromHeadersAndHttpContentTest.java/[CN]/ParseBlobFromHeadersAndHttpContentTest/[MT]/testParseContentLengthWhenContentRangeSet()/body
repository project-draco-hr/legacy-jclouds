{
  ParseSystemAndUserMetadataFromHeaders metadataParser=createMock(ParseSystemAndUserMetadataFromHeaders.class);
  ParseBlobFromHeadersAndHttpContent callable=new ParseBlobFromHeadersAndHttpContent(metadataParser,blobProvider);
  HttpResponse response=createMock(HttpResponse.class);
  MutableBlobMetadata meta=createMock(MutableBlobMetadata.class);
  expect(metadataParser.apply(response)).andReturn(meta);
  InputStream test=IOUtils.toInputStream("test");
  expect(meta.getSize()).andReturn(-1l);
  meta.setSize(-1l);
  expect(response.getFirstHeaderOrNull(HttpHeaders.CONTENT_LENGTH)).andReturn("10485760").atLeastOnce();
  expect(response.getFirstHeaderOrNull("Content-Range")).andReturn("0-10485759/20232760").atLeastOnce();
  expect(response.getHeaders()).andReturn(ImmutableMultimap.of("Content-Length","10485760","Content-Range","0-10485759/20232760"));
  meta.setSize(20232760);
  expect(response.getStatusCode()).andReturn(200).atLeastOnce();
  expect(response.getContent()).andReturn(test);
  expect(meta.getSize()).andReturn(20232760l);
  replay(response);
  replay(metadataParser);
  Blob object=callable.apply(response);
  assertEquals(object.getContentLength(),new Long(10485760));
  assertEquals(object.getMetadata().getSize(),new Long(20232760));
  assertEquals(object.getAllHeaders().get("Content-Range"),Collections.singletonList("0-10485759/20232760"));
}
