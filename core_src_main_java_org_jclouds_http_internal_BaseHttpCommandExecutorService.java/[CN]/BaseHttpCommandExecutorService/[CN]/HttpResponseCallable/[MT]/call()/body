{
  HttpResponse response=null;
  for (; ; ) {
    HttpRequest request=command.getRequest();
    Q nativeRequest=null;
    try {
      for (      HttpRequestFilter filter : request.getFilters()) {
        filter.filter(request);
      }
      logger.debug("Sending request: %s",request.getRequestLine());
      if (request.getEntity() != null && wire.enabled())       request.setEntity(wire.output(request.getEntity()));
      nativeRequest=convert(request);
      if (headerLog.isDebugEnabled()) {
        headerLog.debug(">> %s",request.getRequestLine().toString());
        for (        Entry<String,String> header : request.getHeaders().entries()) {
          if (header.getKey() != null)           headerLog.debug(">> %s: %s",header.getKey(),header.getValue());
        }
      }
      response=invoke(nativeRequest);
      logger.debug("Receiving response: " + response.getStatusLine());
      if (headerLog.isDebugEnabled()) {
        headerLog.debug("<< " + response.getStatusLine().toString());
        for (        Entry<String,String> header : response.getHeaders().entries()) {
          if (header.getKey() != null)           headerLog.debug("<< %s: %s",header.getKey(),header.getValue());
        }
      }
      if (response.getContent() != null && wire.enabled())       response.setContent(wire.input(response.getContent()));
      int statusCode=response.getStatusCode();
      if (statusCode >= 300) {
        if (retryHandler.shouldRetryRequest(command,response)) {
          continue;
        }
 else {
          errorHandler.handleError(command,response);
          break;
        }
      }
 else {
        break;
      }
    }
  finally {
      cleanup(nativeRequest);
    }
  }
  if (command.getException() != null)   throw command.getException();
  return response;
}
