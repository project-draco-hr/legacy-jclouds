{
  checkState(template instanceof CloneImageTemplate," vbox image extension only supports cloning for the moment.");
  CloneImageTemplate cloneTemplate=CloneImageTemplate.class.cast(template);
  IMachine source=manager.get().getVBox().findMachine(cloneTemplate.getSourceNodeId());
  String flags="";
  List<String> groups=ImmutableList.of();
  String group="";
  String settingsFile=manager.get().getVBox().composeMachineFilename(template.getName(),group,flags,workingDir);
  IMachine clonedMachine=manager.get().getVBox().createMachine(settingsFile,template.getName(),groups,source.getOSTypeId(),flags);
  List<CloneOptions> options=Lists.newArrayList();
  if (isLinkedClone)   options.add(CloneOptions.Link);
  ISnapshot currentSnapshot=new TakeSnapshotIfNotAlreadyAttached(manager,"pre-image-spawn","before spawning " + template.getName(),logger).apply(source);
  checkNotNull(currentSnapshot);
  IProgress progress=currentSnapshot.getMachine().cloneTo(clonedMachine,CloneMode.MachineState,options);
  progress.waitForCompletion(-1);
  logger.debug(String.format("<< master(%s) is cloned correctly to vm(%s)",source.getName(),clonedMachine.getName()));
  manager.get().getVBox().registerMachine(clonedMachine);
  return Futures.immediateFuture(imachineToImage.apply(clonedMachine));
}
