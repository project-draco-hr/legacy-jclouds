{
  final Set<NodeMetadata> nodes=Sets.newHashSet();
  Map<String,ListenableFuture<?>> parallelResponses=Maps.newHashMap();
  for (  final String region : regionMap.keySet()) {
    parallelResponses.put(region,ConcurrentUtils.makeListenable(executor.submit(new Callable<Void>(){
      @Override public Void call() throws Exception {
        Iterables.addAll(nodes,Iterables.transform(Iterables.concat(client.describeInstancesInRegion(region)),runningInstanceToNodeMetadata));
        return null;
      }
    }
),executor));
  }
  Map<String,Exception> exceptions=awaitCompletion(parallelResponses,executor,null,logger,"nodes");
  if (exceptions.size() > 0)   throw new RuntimeException(String.format("error parsing nodes in regions: %s",exceptions));
  return Iterables.filter(nodes,filter);
}
