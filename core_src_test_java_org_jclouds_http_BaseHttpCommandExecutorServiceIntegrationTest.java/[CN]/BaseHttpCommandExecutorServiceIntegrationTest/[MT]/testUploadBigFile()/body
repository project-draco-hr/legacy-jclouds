{
  String filename="jclouds";
  OutputStream os=null;
  File f=null;
  try {
    f=File.createTempFile(filename,"tmp");
    f.deleteOnExit();
    long length=(long)(Runtime.getRuntime().freeMemory() * 1.1);
    os=new BufferedOutputStream(new FileOutputStream(f.getAbsolutePath()));
    MessageDigest digester=context.utils().crypto().md5();
    ByteArrayOutputStream out=new ByteArrayOutputStream();
    try {
      for (long i=0; i < length; i++) {
        digester.update((byte)'a');
        os.write((byte)'a');
      }
      os.flush();
    }
 catch (    IOException e) {
      throw new RuntimeException(e);
    }
 finally {
      Closeables.closeQuietly(out);
    }
    Payload payload=Payloads.newFilePayload(f);
    byte[] digest=digester.digest();
    payload.getContentMetadata().setContentMD5(digest);
    Multimap<String,String> headers=client.postPayloadAndReturnHeaders("",payload);
    assertEquals(headers.get("x-Content-MD5"),Collections.singleton(CryptoStreams.base64Encode(InputSuppliers.of(digest))));
    payload.release();
  }
  finally {
    if (os != null)     os.close();
    if (f != null && f.exists())     f.delete();
  }
}
