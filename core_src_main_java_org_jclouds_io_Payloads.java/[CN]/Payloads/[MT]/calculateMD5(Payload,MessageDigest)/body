{
  checkNotNull(payload,"payload");
  if (!payload.isRepeatable()) {
    String oldContentType=payload.getContentMetadata().getContentType();
    Payload oldPayload=payload;
    try {
      payload=newByteArrayPayload(toByteArray(payload));
    }
  finally {
      oldPayload.release();
    }
    payload.getContentMetadata().setContentType(oldContentType);
  }
  payload.getContentMetadata().setContentMD5(CryptoStreams.digest(payload,md5));
  return payload;
}
