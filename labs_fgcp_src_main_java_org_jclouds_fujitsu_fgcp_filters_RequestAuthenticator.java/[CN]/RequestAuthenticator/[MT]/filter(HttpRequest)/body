{
  checkNotNull(request,"request must be present");
  utils.logRequest(signatureLog,request,">>");
  String accessKeyId=createStringToSign(request);
  String signature=sign(accessKeyId);
  String lang=Locale.JAPANESE.getLanguage().equals(Locale.getDefault().getLanguage()) ? Locale.JAPANESE.getLanguage() : Locale.ENGLISH.getLanguage();
  if (HttpMethod.GET.equals(request.getMethod())) {
    request=addQueryParamsToRequest(request,accessKeyId,signature,lang);
  }
 else {
    String payload=request.getPayload().getRawContent().toString();
    payload=createXmlElementWithValue(payload,RequestParameters.VERSION,apiVersion);
    payload=createXmlElementWithValue(payload,RequestParameters.LOCALE,lang);
    payload=createXmlElementWithValue(payload,RequestParameters.ACCESS_KEY_ID,accessKeyId);
    payload=createXmlElementWithValue(payload,RequestParameters.SIGNATURE,signature);
    request.setPayload(payload);
    request.getPayload().getContentMetadata().setContentType(MediaType.TEXT_XML);
  }
  HttpRequest filteredRequest=request.toBuilder().replaceHeader(HttpHeaders.USER_AGENT,"OViSS-API-CLIENT").build();
  utils.logRequest(signatureLog,filteredRequest,">>->");
  return filteredRequest;
}
