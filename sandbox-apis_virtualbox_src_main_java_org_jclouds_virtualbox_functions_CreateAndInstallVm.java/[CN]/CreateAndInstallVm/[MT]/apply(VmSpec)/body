{
  String vmName=vmSpec.getVmName();
  URI preconfigurationUri=preconfiguration.get();
  String keySequence=valueOfConfigurationKeyOrNull.apply(VIRTUALBOX_INSTALLATION_KEY_SEQUENCE).replace("PRECONFIGURATION_URL",preconfigurationUri.toASCIIString()).replace("HOSTNAME",vmName);
  final IMachine vm=createAndRegisterMachineFromIsoIfNotAlreadyExists.apply(vmSpec);
  ensureMachineIsLaunched(vmName);
  sendKeyboardSequence(keySequence,vmName);
  SshClient client=sshClientForIMachine.apply(vm);
  logger.debug(">> awaiting installation to finish node(%s)",vmName);
  checkState(sshResponds.apply(client),"timed out waiting for guest %s to be accessible via ssh",vmName);
  logger.debug("<< installation of image complete. Powering down node(%s)",vmName);
  lockSessionOnMachineAndApply(manager.get(),Shared,vmName,new Function<ISession,Void>(){
    @Override public Void apply(    ISession session){
      IProgress powerDownProgress=session.getConsole().powerDown();
      powerDownProgress.waitForCompletion(-1);
      return null;
    }
  }
);
  return vm;
}
