{
  VmSpec vmSpec=cloneSpec.getVmSpec();
  NetworkSpec networkSpec=cloneSpec.getNetworkSpec();
  boolean isLinkedClone=cloneSpec.isLinked();
  IMachine master=cloneSpec.getMaster();
  String settingsFile=manager.get().getVBox().composeMachineFilename(vmSpec.getVmName(),workingDir);
  IMachine clonedMachine=manager.get().getVBox().createMachine(settingsFile,vmSpec.getVmName(),vmSpec.getOsTypeId(),vmSpec.getVmId(),vmSpec.isForceOverwrite());
  List<CloneOptions> options=new ArrayList<CloneOptions>();
  if (isLinkedClone)   options.add(CloneOptions.Link);
  ISnapshot currentSnapshot=new TakeSnapshotIfNotAlreadyAttached(manager,"snapshotName","snapshotDesc",logger).apply(master);
  IProgress progress=currentSnapshot.getMachine().cloneTo(clonedMachine,CloneMode.MachineState,options);
  progress.waitForCompletion(-1);
  logger.debug(String.format("Machine %s is cloned correctly",clonedMachine.getName()));
  clonedMachine.setMemorySize(cloneSpec.getVmSpec().getMemory());
  manager.get().getVBox().registerMachine(clonedMachine);
  for (  NetworkInterfaceCard networkInterfaceCard : networkSpec.getNetworkInterfaceCards()) {
    new AttachNicToMachine(vmSpec.getVmName(),machineUtils).apply(networkInterfaceCard);
  }
  return clonedMachine;
}
