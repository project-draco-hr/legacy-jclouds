{
  if (networksDisabled)   return;
  BlockUntilJobCompletesAndReturnResult blocker=new BlockUntilJobCompletesAndReturnResult(client,jobComplete);
  StaticNATVirtualMachineInNetwork fn=new StaticNATVirtualMachineInNetwork(client,blocker,reuseOrAssociate,network);
  CreatePortForwardingRulesForIP createPortForwardingRulesForIP=new CreatePortForwardingRulesForIP(client,blocker,CacheBuilder.newBuilder().<Long,Set<IPForwardingRule>>build(new GetIPForwardingRulesByVirtualMachine(client)));
  injector.injectMembers(blocker);
  injector.injectMembers(fn);
  injector.injectMembers(createPortForwardingRulesForIP);
  ip=fn.apply(vm);
  createPortForwardingRulesForIP.apply(ip,ImmutableSet.of(22));
  rule=getOnlyElement(filter(client.getNATClient().getIPForwardingRulesForIPAddress(ip.getId()),new Predicate<IPForwardingRule>(){
    @Override public boolean apply(    @Nullable IPForwardingRule rule){
      return rule != null && rule.getStartPort() == 22;
    }
  }
));
  assertEquals(rule.getIPAddressId(),ip.getId());
  assertEquals(rule.getVirtualMachineId(),vm.getId());
  assertEquals(rule.getStartPort(),22);
  assertEquals(rule.getProtocol(),"tcp");
  checkRule(rule);
  IPSocket socket=new IPSocket(ip.getIPAddress(),22);
  socketTester.apply(socket);
  SshClient client=sshFactory.create(socket,new Credentials("root",password));
  try {
    client.connect();
    ExecResponse exec=client.exec("echo hello");
    assertEquals(exec.getOutput().trim(),"hello");
  }
  finally {
    if (client != null)     client.disconnect();
  }
}
