{
  if (networksDisabled)   return;
  ip=new StaticNATVirtualMachineInNetwork(client,reuseOrAssociate,jobComplete,CacheBuilder.newBuilder().<Long,Set<IPForwardingRule>>build(new GetIPForwardingRulesByVirtualMachine(client)),network).apply(vm);
  rule=getOnlyElement(filter(client.getNATClient().getIPForwardingRulesForIPAddress(ip.getId()),new Predicate<IPForwardingRule>(){
    @Override public boolean apply(    @Nullable IPForwardingRule rule){
      return rule != null && rule.getStartPort() == 22;
    }
  }
));
  assertEquals(rule.getIPAddressId(),ip.getId());
  assertEquals(rule.getVirtualMachineId(),vm.getId());
  assertEquals(rule.getStartPort(),22);
  assertEquals(rule.getProtocol(),"tcp");
  checkRule(rule);
  IPSocket socket=new IPSocket(ip.getIPAddress(),22);
  socketTester.apply(socket);
  SshClient client=sshFactory.create(socket,new Credentials("root",password));
  try {
    client.connect();
    ExecResponse exec=client.exec("echo hello");
    assertEquals(exec.getOutput().trim(),"hello");
  }
  finally {
    if (client != null)     client.disconnect();
  }
}
