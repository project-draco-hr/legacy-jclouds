{
  VCloudDirectorContext rootContext=VCloudDirectorContext.class.cast(new RestContextFactory().createContext(provider,identity,credential,ImmutableSet.<Module>of(new Log4JLoggingModule(),new SshjSshClientModule()),overrides));
  if (rootContext.getApi().getCurrentSession().getLinks().contains(Link.builder().rel("down").type("application/vnd.vmware.admin.vcloud+xml").href(URI.create(endpoint + "/admin/")).build())) {
    adminContext=rootContext.getAdminContext();
    Reference orgRef=Iterables.getFirst(rootContext.getApi().getOrgClient().getOrgList().getOrgs(),null).toAdminReference(endpoint);
    assertNotNull(orgRef,String.format(REF_REQ_LIVE,"admin org"));
    Reference userRef=Iterables.find(adminContext.getApi().getOrgClient().getOrg(orgRef.getHref()).getUsers(),ReferencePredicates.nameEquals(adminContext.getApi().getCurrentSession().getUser()));
    User user=adminContext.getApi().getUserClient().getUser(userRef.getHref());
    Reference orgAdmin=user.getRole();
    assertTrue(equal(orgAdmin.getName(),DefaultRoles.ORG_ADMIN),"must give org admin or user-only credentials");
    String adminIdentity="testAdmin" + BaseVCloudDirectorClientLiveTest.getTestDateTimeStamp();
    String adminCredential="testAdminPassword";
    createdAdminUser=rootContext.getAdminContext().getApi().getUserClient().createUser(orgRef.getHref(),User.builder().name(adminIdentity).password(adminCredential).description("test user with user-level privileges").role(orgAdmin).deployedVmQuota(BaseVCloudDirectorClientLiveTest.REQUIRED_ADMIN_VM_QUOTA).isEnabled(true).build());
    rootContext.close();
    rootContext=null;
    adminContext=VCloudDirectorContext.class.cast(new RestContextFactory().createContext(provider,adminIdentity,adminCredential,ImmutableSet.<Module>of(new Log4JLoggingModule(),new SshjSshClientModule()),overrides)).getAdminContext();
    String userIdentity="test" + BaseVCloudDirectorClientLiveTest.getTestDateTimeStamp();
    String userCredential="testPassword";
    createdUser=adminContext.getApi().getUserClient().createUser(orgRef.getHref(),User.builder().name(userIdentity).password(userCredential).description("test user with user-level privileges").role(BaseVCloudDirectorClientLiveTest.getRoleReferenceFor(DefaultRoles.USER,adminContext)).deployedVmQuota(BaseVCloudDirectorClientLiveTest.REQUIRED_USER_VM_QUOTA).isEnabled(true).build());
    userContext=new RestContextFactory().createContext(provider,userIdentity,userCredential,ImmutableSet.<Module>of(new Log4JLoggingModule(),new SshjSshClientModule()),overrides);
  }
 else {
    userContext=rootContext;
  }
}
