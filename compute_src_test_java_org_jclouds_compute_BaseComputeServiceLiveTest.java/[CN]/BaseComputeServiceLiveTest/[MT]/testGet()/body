{
  Map<String,? extends NodeMetadata> metadataMap=newLinkedHashMap(uniqueIndex(filter(client.listNodesDetailsMatching(all()),and(withTag(tag),not(TERMINATED))),new Function<NodeMetadata,String>(){
    @Override public String apply(    NodeMetadata from){
      return from.getId();
    }
  }
));
  for (  NodeMetadata node : nodes) {
    metadataMap.remove(node.getId());
    NodeMetadata metadata=client.getNodeMetadata(node.getId());
    assertEquals(metadata.getProviderId(),node.getProviderId());
    assertEquals(metadata.getTag(),node.getTag());
    assertLocationSameOrChild(metadata.getLocation(),template.getLocation());
    checkImageIdMatchesTemplate(metadata);
    checkOsMatchesTemplate(metadata);
    assertEquals(metadata.getState(),NodeState.RUNNING);
    assertEquals(metadata.getPrivateAddresses(),node.getPrivateAddresses());
    assertEquals(metadata.getPublicAddresses(),node.getPublicAddresses());
  }
  assertNodeZero(metadataMap.values());
}
