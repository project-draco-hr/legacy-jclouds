{
  Set<? extends NodeMetadata> nodes=client.listNodesDetailsMatching(all());
  Set<? extends NodeMetadata> metadataSet=newLinkedHashSet(filter(nodes,and(withTag(tag),not(TERMINATED))));
  for (  NodeMetadata node : nodes) {
    metadataSet.remove(node);
    NodeMetadata metadata=client.getNodeMetadata(node.getId());
    assertEquals(metadata.getProviderId(),node.getProviderId());
    assertEquals(metadata.getTag(),node.getTag());
    assertLocationSameOrChild(metadata.getLocation(),template.getLocation());
    checkImageIdMatchesTemplate(metadata);
    checkOsMatchesTemplate(metadata);
    assertEquals(metadata.getState(),NodeState.RUNNING);
    assertEquals(metadata.getPrivateAddresses(),node.getPrivateAddresses());
    assertEquals(metadata.getPublicAddresses(),node.getPublicAddresses());
  }
  assertNodeZero(metadataSet);
}
