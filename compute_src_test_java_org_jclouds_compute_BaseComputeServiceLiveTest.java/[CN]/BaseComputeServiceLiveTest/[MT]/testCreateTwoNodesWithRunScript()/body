{
  try {
    client.destroyNodesMatching(withTag(tag));
  }
 catch (  NoSuchElementException e) {
  }
  refreshTemplate();
  try {
    nodes=newTreeSet(client.runNodesWithTag(tag,2,template));
  }
 catch (  RunNodesException e) {
    nodes=newTreeSet(concat(e.getSuccessfulNodes(),e.getNodeErrors().keySet()));
    throw e;
  }
  assertEquals(nodes.size(),2);
  checkNodes(nodes,tag);
  NodeMetadata node1=nodes.first();
  NodeMetadata node2=nodes.last();
  assertLocationSameOrChild(node1.getLocation(),template.getLocation());
  assertLocationSameOrChild(node2.getLocation(),template.getLocation());
  checkImageIdMatchesTemplate(node1);
  checkImageIdMatchesTemplate(node2);
  checkOsMatchesTemplate(node1);
  checkOsMatchesTemplate(node2);
}
