{
  try {
    client.destroyNodesMatching(withTag(tag));
  }
 catch (  HttpResponseException e) {
  }
catch (  NoSuchElementException e) {
  }
  template=buildTemplate(client.templateBuilder());
  template.getOptions().installPrivateKey(newStringPayload(keyPair.get("private"))).authorizePublicKey(newStringPayload(keyPair.get("public"))).runScript(newStringPayload(buildScript(template.getImage().getOsFamily())));
  try {
    nodes=newTreeSet(client.runNodesWithTag(tag,2,template));
  }
 catch (  RunNodesException e) {
    nodes=newTreeSet(concat(e.getSuccessfulNodes(),e.getNodeErrors().keySet()));
    throw e;
  }
  assertEquals(nodes.size(),2);
  checkNodes(nodes,tag);
  NodeMetadata node1=nodes.first();
  NodeMetadata node2=nodes.last();
  assertLocationSameOrChild(node1.getLocation(),template.getLocation());
  assertLocationSameOrChild(node2.getLocation(),template.getLocation());
  if (node1.getImage() != null)   assertEquals(node1.getImage(),template.getImage());
  if (node2.getImage() != null)   assertEquals(node2.getImage(),template.getImage());
}
