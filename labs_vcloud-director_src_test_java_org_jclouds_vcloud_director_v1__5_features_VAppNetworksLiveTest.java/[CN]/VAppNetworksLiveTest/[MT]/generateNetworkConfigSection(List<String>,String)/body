{
  Set<FirewallRule> firewallRules=Sets.newLinkedHashSet();
  for (  String securityGroup : securityGroups) {
    Set<FirewallRule> securityGroupFirewallRules=retrieveAllFirewallRules(securityGroupToNetworkConfig.get(securityGroup).getNetworkFeatures());
    firewallRules.addAll(securityGroupFirewallRules);
  }
  FirewallService firewallService=createFirewallService(firewallRules);
  NatService natService=createNatService();
  IpScope ipScope=createNewIpScope();
  NetworkConfiguration newConfiguration=NetworkConfiguration.builder().ipScope(ipScope).parentNetwork(parentNetworkRef).fenceMode(FenceMode.NAT_ROUTED).retainNetInfoAcrossDeployments(false).features(createNetworkFeatures(ImmutableSet.of(firewallService,natService))).build();
  VAppNetworkConfiguration newVAppNetworkConfiguration=VAppNetworkConfiguration.builder().networkName(newVAppNetworkName).configuration(newConfiguration).build();
  return NetworkConfigSection.builder().info("modified").networkConfigs(ImmutableSet.of(newVAppNetworkConfiguration)).build();
}
