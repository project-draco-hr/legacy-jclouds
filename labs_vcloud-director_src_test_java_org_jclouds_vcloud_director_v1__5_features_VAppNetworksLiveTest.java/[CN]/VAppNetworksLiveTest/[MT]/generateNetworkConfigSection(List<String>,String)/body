{
  Set<FirewallRule> firewallRules=Sets.newLinkedHashSet();
  for (  String securityGroup : securityGroups) {
    Set<FirewallRule> securityGroupFirewallRules=retrieveAllFirewallRules(securityGroupToNetworkConfig.get(securityGroup).getNetworkFeatures());
    firewallRules.addAll(securityGroupFirewallRules);
  }
  FirewallService firewallService=addFirewallService(firewallRules);
  NatService natService=addNatService();
  IpScope ipScope=addNewIpScope();
  NetworkConfiguration newConfiguration=NetworkConfiguration.builder().ipScope(ipScope).parentNetwork(Reference.builder().fromEntity(network).build()).fenceMode(FenceMode.NAT_ROUTED).retainNetInfoAcrossDeployments(false).features(toNetworkFeatures(ImmutableSet.of(firewallService,natService))).build();
  VAppNetworkConfiguration newVAppNetworkConfiguration=VAppNetworkConfiguration.builder().networkName(newVAppNetworkName).configuration(newConfiguration).build();
  return NetworkConfigSection.builder().info("modified").networkConfigs(ImmutableSet.of(newVAppNetworkConfiguration)).build();
}
