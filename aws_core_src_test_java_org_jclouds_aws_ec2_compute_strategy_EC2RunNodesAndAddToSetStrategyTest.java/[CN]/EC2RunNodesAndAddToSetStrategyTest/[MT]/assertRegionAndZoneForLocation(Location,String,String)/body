{
  String imageId="ami1";
  String instanceCreatedId="instance1";
  EC2RunNodesAndAddToSetStrategy strategy=setupStrategy();
  InputParams input=new InputParams(location);
  RunInstancesOptions ec2Options=createMock(RunInstancesOptions.class);
  RunningInstance instance=createMock(RunningInstance.class);
  Reservation reservation=new Reservation(region,ImmutableSet.<String>of(),ImmutableSet.<RunningInstance>of(instance),"ownerId","requesterId","reservationId");
  NodeMetadata nodeMetadata=createMock(NodeMetadata.class);
  expect(strategy.createKeyPairAndSecurityGroupsAsNeededAndReturnRunOptions.execute(region,input.tag,input.template)).andReturn(ec2Options);
  expect(input.template.getLocation()).andReturn(input.location).atLeastOnce();
  expect(input.template.getImage()).andReturn(input.image).atLeastOnce();
  expect(input.image.getId()).andReturn(imageId).atLeastOnce();
  expect(strategy.instanceClient.runInstancesInRegion(region,zone,imageId,1,input.count,ec2Options)).andReturn(reservation);
  expect(instance.getId()).andReturn(instanceCreatedId).atLeastOnce();
  expect(strategy.instanceStateRunning.apply(instance)).andReturn(true);
  expect(strategy.instanceClient.describeInstancesInRegion(region,instanceCreatedId)).andReturn(ImmutableSet.of(reservation));
  expect(input.template.getOptions()).andReturn(input.options).atLeastOnce();
  expect(strategy.runningInstanceToNodeMetadata.apply(instance)).andReturn(nodeMetadata);
  expect(strategy.utils.runOptionsOnNodesAndAddToGoodSetOrPutExceptionIntoBadMap(eq(input.options),containsNodeMetadata(nodeMetadata),eq(input.nodes),eq(input.badNodes))).andReturn(null);
  replay(ec2Options);
  replay(instance);
  replay(nodeMetadata);
  input.replayMe();
  replayStrategy(strategy);
  strategy.execute(input.tag,input.count,input.template,input.nodes,input.badNodes);
  verify(ec2Options);
  verify(instance);
  verify(nodeMetadata);
  input.verifyMe();
  verifyStrategy(strategy);
}
