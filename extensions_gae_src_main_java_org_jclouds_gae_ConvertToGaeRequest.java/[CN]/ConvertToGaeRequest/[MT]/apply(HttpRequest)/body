{
  URL url=null;
  try {
    url=request.getEndpoint().toURL();
  }
 catch (  MalformedURLException e) {
    Throwables.propagate(e);
  }
  FetchOptions options=disallowTruncate();
  options.doNotFollowRedirects();
  HTTPRequest gaeRequest=new HTTPRequest(url,HTTPMethod.valueOf(request.getMethod().toString()),options);
  for (  String header : request.getHeaders().keySet()) {
    for (    String value : request.getHeaders().get(header)) {
      if (!"Transfer-Encoding".equals(header))       gaeRequest.addHeader(new HTTPHeader(header,value));
    }
  }
  gaeRequest.addHeader(new HTTPHeader(HttpHeaders.USER_AGENT,USER_AGENT));
  if (request.getPayload() != null) {
    InputStream input=request.getPayload().getInput();
    try {
      ByteArrayOutputStream out=new ByteArrayOutputStream();
      request.getPayload().writeTo(out);
      byte[] array=out.toByteArray();
      if (!request.getPayload().isRepeatable()) {
        Payload oldPayload=request.getPayload();
        request.setPayload(array);
        if (oldPayload.getContentMD5() != null)         request.getPayload().setContentMD5(oldPayload.getContentMD5());
        if (oldPayload.getContentType() != null)         request.getPayload().setContentType(oldPayload.getContentType());
        if (oldPayload.getContentDisposition() != null)         request.getPayload().setContentDisposition(oldPayload.getContentDisposition());
        if (oldPayload.getContentEncoding() != null)         request.getPayload().setContentEncoding(oldPayload.getContentEncoding());
        if (oldPayload.getContentLanguage() != null)         request.getPayload().setContentLanguage(oldPayload.getContentLanguage());
      }
      gaeRequest.setPayload(array);
    }
 catch (    IOException e) {
      Throwables.propagate(e);
    }
 finally {
      closeQuietly(input);
    }
    if (request.getPayload().getContentMD5() != null)     gaeRequest.setHeader(new HTTPHeader("Content-MD5",CryptoStreams.base64(request.getPayload().getContentMD5())));
    if (request.getPayload().getContentType() != null)     gaeRequest.setHeader(new HTTPHeader(HttpHeaders.CONTENT_TYPE,request.getPayload().getContentType()));
    if (request.getPayload().getContentDisposition() != null)     gaeRequest.setHeader(new HTTPHeader("Content-Disposition",request.getPayload().getContentDisposition()));
    if (request.getPayload().getContentEncoding() != null)     gaeRequest.setHeader(new HTTPHeader("Content-Encoding",request.getPayload().getContentEncoding()));
    if (request.getPayload().getContentLanguage() != null)     gaeRequest.setHeader(new HTTPHeader("Content-Language",request.getPayload().getContentLanguage()));
    Long length=checkNotNull(request.getPayload().getContentLength(),"payload.getContentLength");
    gaeRequest.setHeader(new HTTPHeader(HttpHeaders.CONTENT_LENGTH,length.toString()));
  }
 else {
    gaeRequest.setHeader(new HTTPHeader(HttpHeaders.CONTENT_LENGTH,"0"));
  }
  return gaeRequest;
}
