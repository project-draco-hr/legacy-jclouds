{
  VirtualBoxManager vbm=createNiceMock(VirtualBoxManager.class);
  IVirtualBox vBox=createNiceMock(IVirtualBox.class);
  IMachine vm=createNiceMock(IMachine.class);
  IGuestOSType guestOsType=createNiceMock(IGuestOSType.class);
  String guestOsDescription="ubuntu 11.04 server (i386)";
  String vmDescription="ubuntu-11.04-server-i386";
  expect(vbm.getVBox()).andReturn(vBox).anyTimes();
  expect(vm.getOSTypeId()).andReturn("os-type").anyTimes();
  expect(vBox.getGuestOSType(eq("os-type"))).andReturn(guestOsType);
  expect(vm.getDescription()).andReturn(vmDescription).anyTimes();
  expect(guestOsType.getDescription()).andReturn(guestOsDescription).anyTimes();
  expect(guestOsType.getIs64Bit()).andReturn(true);
  replay(vbm,vBox,vm,guestOsType);
  IMachineToImage fn=new IMachineToImage(Suppliers.ofInstance(vbm),map);
  Image image=fn.apply(vm);
  assertEquals(image.getDescription(),vmDescription);
  assertEquals(image.getOperatingSystem().getDescription(),guestOsDescription);
  assertTrue(image.getOperatingSystem().is64Bit());
  assertEquals(image.getOperatingSystem().getFamily(),OsFamily.UBUNTU);
  assertEquals(image.getOperatingSystem().getVersion(),"11.04");
}
