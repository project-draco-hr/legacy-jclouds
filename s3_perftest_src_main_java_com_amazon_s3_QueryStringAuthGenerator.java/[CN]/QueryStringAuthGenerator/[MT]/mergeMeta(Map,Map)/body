{
  Map merged=new TreeMap();
  if (headers != null) {
    for (Iterator i=headers.keySet().iterator(); i.hasNext(); ) {
      String key=(String)i.next();
      merged.put(key,headers.get(key));
    }
  }
  if (metadata != null) {
    for (Iterator i=metadata.keySet().iterator(); i.hasNext(); ) {
      String key=(String)i.next();
      String metadataKey=Utils.METADATA_PREFIX + key;
      if (merged.containsKey(metadataKey)) {
        ((List)merged.get(metadataKey)).addAll((List)metadata.get(key));
      }
 else {
        merged.put(metadataKey,metadata.get(key));
      }
    }
  }
  return merged;
}
