{
  ISession session=manager.get().getSessionObject();
  while (!manager.get().getVBox().findMachine(vmName).getState().equals(MachineState.PoweredOff)) {
    try {
      session=machineUtils.lockSessionOnMachineAndApply(vmName,LockType.Shared,new Function<ISession,ISession>(){
        @Override public ISession apply(        ISession session){
          IProgress powerDownProgress=session.getConsole().powerDown();
          powerDownProgress.waitForCompletion(-1);
          return session;
        }
      }
);
    }
 catch (    RuntimeException e) {
      if (e.getMessage().contains("Invalid machine state: PoweredOff")) {
        throw e;
      }
 else       if (e.getMessage().contains("VirtualBox error: The object is not ready")) {
        continue;
      }
 else {
        throw e;
      }
    }
  }
  return checkNotNull(session,"session");
}
