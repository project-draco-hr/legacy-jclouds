{
  String adminDiskPath="/Users/johndoe/jclouds-virtualbox-images/admin.vdi";
  String diskFormat="vdi";
  VirtualBoxManager manager=createNiceMock(VirtualBoxManager.class);
  IMachine machine=createMock(IMachine.class);
  IVirtualBox vBox=createMock(IVirtualBox.class);
  IMedium hardDisk=createMock(IMedium.class);
  IMedium newHardDisk=createMock(IMedium.class);
  IProgress progress=createNiceMock(IProgress.class);
  expect(manager.getVBox()).andReturn(vBox).anyTimes();
  expect(vBox.findMedium(adminDiskPath,DeviceType.HardDisk)).andReturn(hardDisk);
  expect(hardDisk.deleteStorage()).andReturn(progress);
  expect(vBox.createHardDisk(diskFormat,adminDiskPath)).andReturn(newHardDisk);
  expect(newHardDisk.createBaseStorage(anyLong(),anyLong())).andReturn(progress);
  replay(manager,machine,vBox,hardDisk,newHardDisk,progress);
  IMedium newDisk=new CreateMediumIfNotAlreadyExists(manager,diskFormat,true).apply(adminDiskPath);
  verify(machine,vBox,hardDisk);
  assertNotSame(newDisk,hardDisk);
}
