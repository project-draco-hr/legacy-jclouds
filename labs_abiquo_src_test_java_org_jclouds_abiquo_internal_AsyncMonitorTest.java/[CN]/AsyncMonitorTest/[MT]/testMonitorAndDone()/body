{
  ScheduledFuture mockFuture=EasyMock.createMock(ScheduledFuture.class);
  expect(mockFuture.isCancelled()).andReturn(true);
  ScheduledExecutorService schedulerMock=EasyMock.createMock(ScheduledExecutorService.class);
  expect(schedulerMock.scheduleWithFixedDelay(anyObject(Runnable.class),anyLong(),anyLong(),anyObject(TimeUnit.class))).andReturn(mockFuture);
  replay(mockFuture);
  replay(schedulerMock);
  CoutingEventHandler handler=new CoutingEventHandler();
  EventBus eventBus=new EventBus();
  eventBus.register(handler);
  AsyncMonitor<Object> monitor=mockMonitor(schedulerMock,new Object(),mockFunction(MonitorStatus.DONE),eventBus);
  assertNull(monitor.getFuture());
  assertNull(monitor.getTimeout());
  monitor.startMonitoring(null,TimeUnit.MILLISECONDS);
  assertNotNull(monitor.getFuture());
  assertNull(monitor.getTimeout());
  monitor.run();
  assertEquals(handler.numCompletes,1);
  assertEquals(handler.numFailures,0);
  assertEquals(handler.numTimeouts,0);
  verify(mockFuture);
  verify(schedulerMock);
}
