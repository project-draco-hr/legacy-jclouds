{
  boolean chunked="chunked".equals(request.getFirstHeaderOrNull("Transfer-Encoding"));
  URL url=request.getEndpoint().toURL();
  HttpURLConnection connection;
  if (utils.useSystemProxies()) {
    System.setProperty("java.net.useSystemProxies","true");
    Iterable<Proxy> proxies=ProxySelector.getDefault().select(request.getEndpoint());
    Proxy proxy=getLast(proxies);
    connection=(HttpURLConnection)url.openConnection(proxy);
  }
 else   if (utils.getProxyHost() != null) {
    SocketAddress addr=new InetSocketAddress(utils.getProxyHost(),utils.getProxyPort());
    Proxy proxy=new Proxy(Proxy.Type.HTTP,addr);
    Authenticator authenticator=new Authenticator(){
      public PasswordAuthentication getPasswordAuthentication(){
        return (new PasswordAuthentication(utils.getProxyUser(),utils.getProxyPassword().toCharArray()));
      }
    }
;
    Authenticator.setDefault(authenticator);
    connection=(HttpURLConnection)url.openConnection(proxy);
  }
 else {
    connection=(HttpURLConnection)url.openConnection();
  }
  if (connection instanceof HttpsURLConnection) {
    HttpsURLConnection sslCon=(HttpsURLConnection)connection;
    if (utils.relaxHostname())     sslCon.setHostnameVerifier(verifier);
    if (utils.trustAllCerts())     sslCon.setSSLSocketFactory(untrustedSSLContextProvider.get().getSocketFactory());
  }
  connection.setDoOutput(true);
  connection.setAllowUserInteraction(false);
  connection.setInstanceFollowRedirects(false);
  try {
    connection.setRequestMethod(request.getMethod());
  }
 catch (  ProtocolException e) {
    try {
      methodField.set(connection,request.getMethod());
    }
 catch (    Exception e1) {
      logger.error(e,"could not set request method: ",request.getMethod());
      Throwables.propagate(e1);
    }
  }
  for (  String header : request.getHeaders().keySet()) {
    for (    String value : request.getHeaders().get(header)) {
      connection.setRequestProperty(header,value);
    }
  }
  connection.setRequestProperty(HttpHeaders.HOST,request.getEndpoint().getHost());
  connection.setRequestProperty(HttpHeaders.USER_AGENT,USER_AGENT);
  if (request.getPayload() != null) {
    MutableContentMetadata md=request.getPayload().getContentMetadata();
    if (md.getContentMD5() != null)     connection.setRequestProperty("Content-MD5",CryptoStreams.base64(md.getContentMD5()));
    if (md.getContentType() != null)     connection.setRequestProperty(HttpHeaders.CONTENT_TYPE,md.getContentType());
    if (md.getContentDisposition() != null)     connection.setRequestProperty("Content-Disposition",md.getContentDisposition());
    if (md.getContentEncoding() != null)     connection.setRequestProperty("Content-Encoding",md.getContentEncoding());
    if (md.getContentLanguage() != null)     connection.setRequestProperty("Content-Language",md.getContentLanguage());
    if (chunked) {
      connection.setChunkedStreamingMode(8196);
    }
 else {
      Long length=checkNotNull(md.getContentLength(),"payload.getContentLength");
      connection.setRequestProperty(HttpHeaders.CONTENT_LENGTH,length.toString());
      connection.setFixedLengthStreamingMode(length.intValue());
    }
    try {
      request.getPayload().writeTo(connection.getOutputStream());
    }
 catch (    IOException e) {
      e.printStackTrace();
      throw e;
    }
  }
 else {
    connection.setRequestProperty(HttpHeaders.CONTENT_LENGTH,"0");
    if (connection.getRequestMethod().equals("POST"))     connection.setChunkedStreamingMode(0);
  }
  return connection;
}
