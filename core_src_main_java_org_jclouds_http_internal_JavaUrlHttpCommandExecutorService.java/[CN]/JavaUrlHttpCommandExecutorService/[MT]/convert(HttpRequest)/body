{
  URL url=request.getEndpoint().toURL();
  boolean chunked=false;
  for (  String header : request.getHeaders().keySet()) {
    for (    String value : request.getHeaders().get(header)) {
      if ("Transfer-Encoding".equals(header) && "chunked".equals(value)) {
        chunked=true;
      }
    }
  }
  HttpURLConnection connection;
  if (utils.useSystemProxies()) {
    System.setProperty("java.net.useSystemProxies","true");
    Iterable<Proxy> proxies=ProxySelector.getDefault().select(request.getEndpoint());
    Proxy proxy=Iterables.getLast(proxies);
    connection=(HttpURLConnection)url.openConnection(proxy);
  }
 else   if (utils.getProxyHost() != null) {
    SocketAddress addr=new InetSocketAddress(utils.getProxyHost(),utils.getProxyPort());
    Proxy proxy=new Proxy(Proxy.Type.HTTP,addr);
    Authenticator authenticator=new Authenticator(){
      public PasswordAuthentication getPasswordAuthentication(){
        return (new PasswordAuthentication(utils.getProxyUser(),utils.getProxyPassword().toCharArray()));
      }
    }
;
    Authenticator.setDefault(authenticator);
    connection=(HttpURLConnection)url.openConnection(proxy);
  }
 else {
    connection=(HttpURLConnection)url.openConnection();
  }
  if (utils.relaxHostname() && connection instanceof HttpsURLConnection) {
    HttpsURLConnection sslCon=(HttpsURLConnection)connection;
    sslCon.setHostnameVerifier(verifier);
  }
  connection.setDoOutput(true);
  connection.setAllowUserInteraction(false);
  connection.setInstanceFollowRedirects(false);
  connection.setRequestMethod(request.getMethod().toString());
  for (  String header : request.getHeaders().keySet()) {
    for (    String value : request.getHeaders().get(header)) {
      connection.setRequestProperty(header,value);
    }
  }
  connection.setRequestProperty(HttpHeaders.HOST,request.getEndpoint().getHost());
  connection.setRequestProperty(HttpHeaders.USER_AGENT,USER_AGENT);
  if (request.getPayload() != null) {
    OutputStream out=null;
    try {
      if (chunked) {
        connection.setChunkedStreamingMode(8192);
      }
 else {
        connection.setFixedLengthStreamingMode(Integer.parseInt(request.getFirstHeaderOrNull(HttpHeaders.CONTENT_LENGTH)));
      }
      out=connection.getOutputStream();
      request.getPayload().writeTo(out);
      out.flush();
    }
  finally {
      Closeables.closeQuietly(out);
    }
  }
 else {
    connection.setRequestProperty(HttpHeaders.CONTENT_LENGTH,"0");
  }
  return connection;
}
