{
  for (  String zoneId : novaContext.getApi().getConfiguredZones()) {
    Optional<FloatingIPClient> clientOption=novaContext.getApi().getFloatingIPExtensionForZone(zoneId);
    if (!clientOption.isPresent())     continue;
    FloatingIPClient client=clientOption.get();
    ServerClient serverClient=novaContext.getApi().getServerClientForZone(zoneId);
    Server server=createServerInZone(zoneId);
    FloatingIP floatingIP=client.allocate();
    assertNotNull(floatingIP);
    try {
      client.addFloatingIPToServer(floatingIP.getIp(),server.getId());
      assertEventually(new ServerHasFloatingIP(serverClient,server.getId(),floatingIP.getIp()));
    }
  finally {
      client.removeFloatingIPFromServer(floatingIP.getIp(),server.getId());
      serverClient.deleteServer(server.getId());
    }
  }
}
