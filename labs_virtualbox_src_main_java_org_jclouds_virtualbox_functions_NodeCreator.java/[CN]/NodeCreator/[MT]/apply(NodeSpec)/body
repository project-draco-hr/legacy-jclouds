{
  checkNotNull(nodeSpec,"NodeSpec");
  Master master=checkNotNull(nodeSpec.getMaster(),"Master");
  if (master.getMachine().getCurrentSnapshot() != null) {
    ISession session;
    try {
      session=manager.get().openMachineSession(master.getMachine());
    }
 catch (    Exception e) {
      throw new RuntimeException("error opening vbox machine session: " + e.getMessage(),e);
    }
    IProgress progress=session.getConsole().deleteSnapshot(master.getMachine().getCurrentSnapshot().getId());
    progress.waitForCompletion(-1);
    session.unlockMachine();
  }
  String masterNameWithoutPrefix=master.getMachine().getName().replace(VIRTUALBOX_IMAGE_PREFIX,"");
  String cloneName=VIRTUALBOX_NODE_PREFIX + masterNameWithoutPrefix + VIRTUALBOX_NODE_NAME_SEPARATOR+ nodeSpec.getTag()+ VIRTUALBOX_NODE_NAME_SEPARATOR+ nodeSpec.getName();
  if (nodeSpec.getTemplate() != null && nodeSpec.getTemplate().getHardware() != null && nodeSpec.getTemplate().getHardware().getRam() > 0) {
    ram=nodeSpec.getTemplate().getHardware().getRam();
  }
  VmSpec cloneVmSpec=VmSpec.builder().id(cloneName).name(cloneName).memoryMB(ram).cleanUpMode(CleanupMode.Full).forceOverwrite(true).build();
  NetworkSpec networkSpec=createNetworkSpecWhenVboxIsLocalhost();
  Optional<NetworkInterfaceCard> optionalNatIfaceCard=Iterables.tryFind(networkSpec.getNetworkInterfaceCards(),new Predicate<NetworkInterfaceCard>(){
    @Override public boolean apply(    NetworkInterfaceCard nic){
      return nic.getNetworkAdapter().getNetworkAttachmentType().equals(NetworkAttachmentType.NAT);
    }
  }
);
  CloneSpec cloneSpec=CloneSpec.builder().linked(true).master(master.getMachine()).network(networkSpec).vm(cloneVmSpec).build();
  IMachine cloned=cloner.apply(cloneSpec);
  machineController.ensureMachineIsLaunched(cloneVmSpec.getVmName());
  NodeMetadata partialNodeMetadata=buildPartialNodeMetadata(cloned);
  machineUtils.runScriptOnNode(partialNodeMetadata,new DeleteGShadowLock(),RunScriptOptions.NONE);
  if (optionalNatIfaceCard.isPresent())   machineUtils.runScriptOnNode(partialNodeMetadata,new EnableNetworkInterface(optionalNatIfaceCard.get()),RunScriptOptions.NONE);
  return new NodeAndInitialCredentials<IMachine>(cloned,cloneName,LoginCredentials.builder().user(guestIdentity).password(guestCredential).authenticateSudo(true).build());
}
