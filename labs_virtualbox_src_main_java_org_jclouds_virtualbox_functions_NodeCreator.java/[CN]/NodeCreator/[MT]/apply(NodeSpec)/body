{
  checkNotNull(nodeSpec,"NodeSpec");
  Master master=nodeSpec.getMaster();
  checkNotNull(master,"Master");
  if (master.getMachine().getCurrentSnapshot() != null) {
    ISession session;
    try {
      session=manager.get().openMachineSession(master.getMachine());
    }
 catch (    Exception e) {
      throw new RuntimeException("error opening vbox machine session: " + e.getMessage(),e);
    }
    IProgress progress=session.getConsole().deleteSnapshot(master.getMachine().getCurrentSnapshot().getId());
    progress.waitForCompletion(-1);
    session.unlockMachine();
  }
  String masterNameWithoutPrefix=master.getSpec().getVmSpec().getVmName().replace(VIRTUALBOX_IMAGE_PREFIX,"");
  String cloneName=VIRTUALBOX_NODE_PREFIX + masterNameWithoutPrefix + VIRTUALBOX_NODE_NAME_SEPARATOR+ nodeSpec.getTag()+ VIRTUALBOX_NODE_NAME_SEPARATOR+ nodeSpec.getName();
  VmSpec cloneVmSpec=VmSpec.builder().id(cloneName).name(cloneName).memoryMB(512).cleanUpMode(CleanupMode.Full).forceOverwrite(true).build();
  NetworkAdapter natAdapter=NetworkAdapter.builder().networkAttachmentType(NetworkAttachmentType.NAT).tcpRedirectRule("127.0.0.1",this.nodePorts.getAndIncrement(),"",22).build();
  NetworkInterfaceCard natIfaceCard=NetworkInterfaceCard.builder().addNetworkAdapter(natAdapter).slot(0L).build();
  NetworkAdapter hostOnlyAdapter=NetworkAdapter.builder().networkAttachmentType(NetworkAttachmentType.HostOnly).staticIp(VMS_NETWORK + this.nodeIps.getAndIncrement()).build();
  NetworkInterfaceCard hostOnlyIfaceCard=NetworkInterfaceCard.builder().addNetworkAdapter(hostOnlyAdapter).addHostInterfaceName(HOST_ONLY_IFACE_NAME).slot(1L).build();
  NetworkSpec networkSpec=createNetworkSpecForHostOnlyNATNICs(natIfaceCard,hostOnlyIfaceCard);
  CloneSpec cloneSpec=CloneSpec.builder().linked(USE_LINKED).master(master.getMachine()).network(networkSpec).vm(cloneVmSpec).build();
  IMachine cloned=cloner.apply(cloneSpec);
  new LaunchMachineIfNotAlreadyRunning(manager.get(),EXECUTION_TYPE,"").apply(cloned);
  NodeMetadata partialNodeMetadata=buildPartialNodeMetadata(cloned);
  machineUtils.runScriptOnNode(partialNodeMetadata,new DeleteGShadowLock(),RunScriptOptions.NONE);
  machineUtils.runScriptOnNode(partialNodeMetadata,new SetIpAddress(hostOnlyIfaceCard),RunScriptOptions.NONE);
  NodeAndInitialCredentials<IMachine> nodeAndInitialCredentials=new NodeAndInitialCredentials<IMachine>(cloned,cloneName,LoginCredentials.builder().user("toor").password("password").authenticateSudo(true).build());
  return nodeAndInitialCredentials;
}
