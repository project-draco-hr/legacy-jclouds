{
  checkNotNull(nodeSpec,"NodeSpec");
  Master master=checkNotNull(nodeSpec.getMaster(),"Master");
  if (master.getMachine().getCurrentSnapshot() != null) {
    ISession session;
    try {
      session=manager.get().getSessionObject();
      master.getMachine().lockMachine(session,LockType.Write);
      IProgress progress=session.getConsole().deleteSnapshot(master.getMachine().getCurrentSnapshot().getId());
      progress.waitForCompletion(-1);
      session.unlockMachine();
    }
 catch (    Exception e) {
      throw new RuntimeException("error opening vbox machine session: " + e.getMessage(),e);
    }
    logger.debug("<< deleted an existing snapshot of vm(%s)",master.getMachine().getName());
  }
  String masterNameWithoutPrefix=master.getMachine().getName().replace(VIRTUALBOX_IMAGE_PREFIX,"");
  String cloneName=VIRTUALBOX_NODE_PREFIX + masterNameWithoutPrefix + VIRTUALBOX_NODE_NAME_SEPARATOR+ nodeSpec.getTag()+ VIRTUALBOX_NODE_NAME_SEPARATOR+ nodeSpec.getName();
  IMachine masterMachine=master.getMachine();
  String username=masterMachine.getExtraData(GUEST_OS_USER);
  String password=masterMachine.getExtraData(GUEST_OS_PASSWORD);
  VmSpec cloneVmSpec=VmSpec.builder().id(cloneName).name(cloneName).memoryMB(ram).guestUser(username).guestPassword(password).cleanUpMode(CleanupMode.Full).forceOverwrite(true).build();
  NetworkSpec networkSpec=networkUtils.createNetworkSpecWhenVboxIsLocalhost();
  Optional<NetworkInterfaceCard> optionalNatIfaceCard=Iterables.tryFind(networkSpec.getNetworkInterfaceCards(),new Predicate<NetworkInterfaceCard>(){
    @Override public boolean apply(    NetworkInterfaceCard nic){
      return nic.getNetworkAdapter().getNetworkAttachmentType().equals(NetworkAttachmentType.NAT);
    }
  }
);
  CloneSpec cloneSpec=CloneSpec.builder().linked(true).master(master.getMachine()).network(networkSpec).vm(cloneVmSpec).build();
  IMachine cloned=cloner.apply(cloneSpec);
  logger.debug("<< cloned a vm(%s) from master(%s)",cloneName,master.getMachine().getName());
  machineController.ensureMachineIsLaunched(cloneVmSpec.getVmName());
  NodeMetadata partialNodeMetadata=buildPartialNodeMetadata(cloned);
  machineUtils.runScriptOnNode(partialNodeMetadata,new DeleteGShadowLock(),RunScriptOptions.NONE);
  if (optionalNatIfaceCard.isPresent())   checkState(networkUtils.enableNetworkInterface(partialNodeMetadata,optionalNatIfaceCard.get()),"cannot enable NAT Interface on vm(%s)",cloneName);
  machineUtils.runScriptOnNode(partialNodeMetadata,new PasswordlessSudo(partialNodeMetadata.getCredentials().identity),RunScriptOptions.Builder.runAsRoot(true));
  LoginCredentials credentials=partialNodeMetadata.getCredentials();
  return new NodeAndInitialCredentials<IMachine>(cloned,cloneName,credentials);
}
