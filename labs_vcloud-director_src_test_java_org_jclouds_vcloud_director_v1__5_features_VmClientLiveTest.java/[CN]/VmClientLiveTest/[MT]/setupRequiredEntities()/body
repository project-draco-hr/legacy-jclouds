{
  Set<Link> links=vdcClient.getVdc(vdcURI).getLinks();
  if (mediaURI == null) {
    Predicate<Link> addMediaLink=and(relEquals(Link.Rel.ADD),typeEquals(VCloudDirectorMediaType.MEDIA));
    if (contains(links,addMediaLink)) {
      Link addMedia=find(links,addMediaLink);
      byte[] iso=new byte[]{0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15};
      Media sourceMedia=Media.builder().type(VCloudDirectorMediaType.MEDIA).name(name("media")).size(iso.length).imageType(Media.ImageType.ISO).description("Test media generated by VmClientLiveTest").build();
      Media media=context.getApi().getMediaClient().createMedia(addMedia.getHref(),sourceMedia);
      Link uploadLink=getFirst(getFirst(media.getFiles(),null).getLinks(),null);
      context.getApi().getUploadClient().upload(uploadLink.getHref(),Payloads.newByteArrayPayload(iso));
      media=context.getApi().getMediaClient().getMedia(media.getHref());
      if (media.getTasks().size() == 1) {
        Task uploadTask=Iterables.getOnlyElement(media.getTasks());
        Checks.checkTask(uploadTask);
        assertEquals(uploadTask.getStatus(),Task.Status.RUNNING);
        assertTrue(retryTaskSuccess.apply(uploadTask),String.format(TASK_COMPLETE_TIMELY,"uploadTask"));
        media=context.getApi().getMediaClient().getMedia(media.getHref());
      }
      mediaURI=media.getHref();
      mediaCreated=true;
    }
  }
  if (adminContext != null) {
    Link orgLink=find(links,and(relEquals("up"),typeEquals(VCloudDirectorMediaType.ORG)));
    testUserURI=adminContext.getApi().getUserClient().createUser(toAdminUri(orgLink),randomTestUser("VAppAccessTest")).getHref();
  }
 else {
    testUserURI=userURI;
  }
}
