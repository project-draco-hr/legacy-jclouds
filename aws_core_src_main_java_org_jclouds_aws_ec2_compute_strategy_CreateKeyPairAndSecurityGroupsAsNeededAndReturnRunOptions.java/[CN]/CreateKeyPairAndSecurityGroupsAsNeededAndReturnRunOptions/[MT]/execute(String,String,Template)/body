{
  checkArgument(template.getSize() instanceof EC2Size,"unexpected image type. should be EC2Size, was: " + template.getSize().getClass());
  EC2Size ec2Size=EC2Size.class.cast(template.getSize());
  String keyPairName=createNewKeyPairUnlessUserSpecifiedOtherwise(region,tag,template.getOptions());
  Set<String> groups=getSecurityGroupsForTagAndOptions(region,tag,template.getOptions());
  RunInstancesOptions instanceOptions=asType(ec2Size.getInstanceType()).withSecurityGroups(groups).withAdditionalInfo(tag);
  if (keyPairName != null)   instanceOptions.withKeyName(keyPairName);
  return instanceOptions;
}
