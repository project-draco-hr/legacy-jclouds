{
  Set<String> groups=Sets.newLinkedHashSet();
  if (tag != null) {
    String markerGroup="jclouds#" + tag;
    groups.add(markerGroup);
    RegionNameAndIngressRules regionNameAndIngessRulesForMarkerGroup;
    if (options instanceof EC2TemplateOptions && EC2TemplateOptions.class.cast(options).getGroupIds().size() > 0) {
      regionNameAndIngessRulesForMarkerGroup=new RegionNameAndIngressRules(region,markerGroup,new int[]{},false);
      groups.addAll(EC2TemplateOptions.class.cast(options).getGroupIds());
    }
 else {
      regionNameAndIngessRulesForMarkerGroup=new RegionNameAndIngressRules(region,markerGroup,options.getInboundPorts(),true);
    }
    if (!securityGroupMap.containsKey(regionNameAndIngessRulesForMarkerGroup)) {
      securityGroupMap.put(regionNameAndIngessRulesForMarkerGroup,createSecurityGroupIfNeeded.apply(regionNameAndIngessRulesForMarkerGroup));
    }
  }
  return groups;
}
