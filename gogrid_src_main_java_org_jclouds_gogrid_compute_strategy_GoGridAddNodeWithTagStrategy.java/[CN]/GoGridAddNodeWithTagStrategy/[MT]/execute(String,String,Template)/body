{
  Server addedServer=null;
  boolean notStarted=true;
  int numOfRetries=20;
  while (notStarted) {
    Set<Ip> availableIps=client.getIpServices().getIpList(new GetIpListOptions().onlyUnassigned().onlyWithType(IpType.PUBLIC));
    if (availableIps.size() == 0)     throw new RuntimeException("No public IPs available on this account.");
    int ipIndex=new SecureRandom().nextInt(availableIps.size());
    Ip availableIp=Iterables.get(availableIps,ipIndex);
    try {
      addedServer=addServer(name,template,availableIp);
      notStarted=false;
    }
 catch (    Exception e) {
      if (--numOfRetries == 0)       Throwables.propagate(e);
      notStarted=true;
    }
  }
  serverLatestJobCompleted.apply(addedServer);
  client.getServerServices().power(addedServer.getName(),PowerCommand.START);
  serverLatestJobCompletedShort.apply(addedServer);
  addedServer=Iterables.getOnlyElement(client.getServerServices().getServersByName(addedServer.getName()));
  return serverToNodeMetadata.apply(addedServer);
}
