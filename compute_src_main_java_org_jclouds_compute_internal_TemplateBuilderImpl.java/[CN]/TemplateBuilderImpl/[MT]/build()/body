{
  if (nothingChangedExceptOptions()) {
    TemplateBuilder defaultTemplate=defaultTemplateProvider.get();
    if (options != null)     defaultTemplate.options(options);
    return defaultTemplate.build();
  }
  if (locationId == null)   locationId=defaultLocation.getId();
  if (options == null)   options=optionsProvider.get();
  logger.debug(">> searching params(%s)",this);
  Location location=resolveLocation();
  List<? extends Image> images=resolveImages();
  final Size size=resolveSize(sizeSorter(),images);
  Image image=Iterables.find(images,new Predicate<Image>(){
    @Override public boolean apply(    Image input){
      return size.supportsImage(input);
    }
  }
);
  logger.debug("<<   matched image(%s)",image);
  this.arch=image.getArchitecture();
  return new TemplateImpl(image,size,location,options);
}
