{
  Cache<RegionAndName,? extends Image> imageMap;
  if (knownImage != null) {
    final RegionAndName knownRegionAndName=new RegionAndName(knownImage.getLocation().getId(),knownImage.getProviderId());
    imageMap=CacheBuilder.newBuilder().build(new CacheLoader<RegionAndName,Image>(){
      @Override public Image load(      RegionAndName from){
        return from.equals(knownRegionAndName) ? knownImage : null;
      }
    }
);
  }
 else {
    imageMap=CacheBuilder.newBuilder().build(new CacheLoader<RegionAndName,Image>(){
      @Override public Image load(      RegionAndName from){
        return uniqueIndex(images.get(),new Function<Image,RegionAndName>(){
          @Override public RegionAndName apply(          Image from){
            return new RegionAndName(from.getLocation().getId(),from.getProviderId());
          }
        }
).get(from);
      }
    }
);
  }
  return new EC2TemplateBuilderImpl(locations,images,sizes,Suppliers.ofInstance(defaultLocation),optionsProvider,templateBuilderProvider,Suppliers.<Cache<RegionAndName,? extends Image>>ofInstance(imageMap));
}
