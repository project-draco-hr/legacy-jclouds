{
  String region=Region.AP_SOUTHEAST_1;
  String tag="tag";
  String userSuppliedPlacementGroup=null;
  boolean shouldAutomaticallyCreatePlacementGroup=true;
  String generatedMarkerGroup="jclouds#tag#" + Region.AP_SOUTHEAST_1;
  CreateKeyPairPlacementAndSecurityGroupsAsNeededAndReturnRunOptions strategy=setupStrategy();
  EC2TemplateOptions options=createMock(EC2TemplateOptions.class);
  expect(options.getPlacementGroup()).andReturn(userSuppliedPlacementGroup);
  expect(options.shouldAutomaticallyCreatePlacementGroup()).andReturn(shouldAutomaticallyCreatePlacementGroup);
  expect(strategy.placementGroupMap.containsKey(new RegionAndName(region,generatedMarkerGroup))).andReturn(false);
  expect(strategy.createPlacementGroupIfNeeded.apply(new RegionAndName(region,generatedMarkerGroup))).andReturn(generatedMarkerGroup);
  expect(strategy.placementGroupMap.put(new RegionAndName(region,generatedMarkerGroup),generatedMarkerGroup)).andReturn(null);
  replay(options);
  replayStrategy(strategy);
  assertEquals(strategy.createNewPlacementGroupUnlessUserSpecifiedOtherwise(region,tag,options),generatedMarkerGroup);
  verify(options);
  verifyStrategy(strategy);
}
