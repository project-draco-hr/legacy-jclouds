{
  String workingDir=PropertyUtils.getWorkingDirFromProperty();
  String settingsFile=manager.getVBox().composeMachineFilename(vmSpec.getVmName(),workingDir);
  IMachine clonedMachine=manager.getVBox().createMachine(settingsFile,vmSpec.getVmName(),vmSpec.getOsTypeId(),vmSpec.getVmId(),vmSpec.isForceOverwrite());
  List<CloneOptions> options=new ArrayList<CloneOptions>();
  if (cloneOptions != null)   options.add(cloneOptions);
  ISnapshot currentSnapshot=new TakeSnapshotIfNotAlreadyAttached(manager,"snapshotName","snapshotDesc").apply(master);
  IProgress progress=currentSnapshot.getMachine().cloneTo(clonedMachine,CloneMode.MachineState,options);
  if (progress.getCompleted())   logger.debug("clone done");
  manager.getVBox().registerMachine(clonedMachine);
  return clonedMachine;
}
