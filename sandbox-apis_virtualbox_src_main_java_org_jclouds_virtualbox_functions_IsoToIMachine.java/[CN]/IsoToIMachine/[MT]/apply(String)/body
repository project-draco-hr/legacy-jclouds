{
  String port=System.getProperty(VirtualBoxConstants.VIRTUALBOX_JETTY_PORT,"8080");
  String baseResource=".";
  Server server=new StartJettyIfNotAlreadyRunning(port).apply(baseResource);
  IMachine vm=new CreateAndRegisterMachineFromIsoIfNotAlreadyExists(settingsFile,osTypeId,vmId,forceOverwrite,manager).apply(vmName);
  String defaultWorkingDir=System.getProperty("user.home") + "/jclouds-virtualbox-test";
  String workingDir=System.getProperty(VIRTUALBOX_WORKINGDIR,defaultWorkingDir);
  ensureMachineHasMemory(vmName,1024l);
  ensureMachineHasIDEControllerNamed(vmName,controllerIDE);
  ensureMachineHasAttachedDistroMedium(isoName,workingDir,controllerIDE);
  String adminDiskPath=workingDir + "/" + adminDisk;
  if (new File(adminDiskPath).exists()) {
    new File(adminDiskPath).delete();
  }
  IMedium hardDisk=new CreateMediumIfNotAlreadyExists(manager,diskFormat,true).apply(adminDiskPath);
  ensureMachineHasHardDiskAttached(vmName,hardDisk);
  ensureNATNetworkingIsAppliedToMachine(vmName);
  String guestAdditionsDvd=workingDir + "/VBoxGuestAdditions_4.1.2.iso";
  final IMedium guestAdditionsDvdMedium=manager.getVBox().openMedium(guestAdditionsDvd,DeviceType.DVD,AccessMode.ReadOnly,forceOverwrite);
  ensureGuestAdditionsMediumIsAttached(vmName,guestAdditionsDvdMedium);
  IProgress prog=vm.launchVMProcess(manager.getSessionObject(),"gui","");
  prog.waitForCompletion(-1);
  try {
    Thread.sleep(5000);
  }
 catch (  InterruptedException e) {
    propagate(e);
  }
  String installKeySequence=System.getProperty(VIRTUALBOX_INSTALLATION_KEY_SEQUENCE,defaultInstallSequence());
  sendKeyboardSequence(installKeySequence);
  boolean sshDeamonIsRunning=false;
  while (!sshDeamonIsRunning) {
    try {
      if (runScriptOnNode(guestId,"id",wrapInInitScript(false)).getExitCode() == 0) {
        logger.debug("Got response from ssh daemon.");
        sshDeamonIsRunning=true;
      }
    }
 catch (    SshException e) {
      logger.debug("No response from ssh daemon...");
    }
  }
  logger.debug("Installation of image complete. Powering down...");
  lockSessionOnMachineAndApply(manager,Shared,vmName,new Function<ISession,Void>(){
    @Override public Void apply(    ISession session){
      IProgress powerDownProgress=session.getConsole().powerDown();
      powerDownProgress.waitForCompletion(-1);
      return null;
    }
  }
);
  try {
    logger.debug("Stopping Jetty server...");
    server.stop();
    logger.debug("Jetty server stopped.");
  }
 catch (  Exception e) {
    logger.error(e,"Could not stop Jetty server.");
  }
  return vm;
}
