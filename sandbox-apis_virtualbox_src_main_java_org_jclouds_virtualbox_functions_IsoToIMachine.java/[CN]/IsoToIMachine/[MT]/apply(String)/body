{
  String port=System.getProperty(VirtualBoxConstants.VIRTUALBOX_JETTY_PORT,"8080");
  String basebaseResource=".";
  Server server=new StartJettyIfNotAlreadyRunning(port).apply(basebaseResource);
  IMachine vm=manager.getVBox().createMachine(settingsFile,vmName,osTypeId,vmId,forceOverwrite);
  manager.getVBox().registerMachine(vm);
  String defaultWorkingDir=System.getProperty("user.home") + "/jclouds-virtualbox-test";
  String workingDir=System.getProperty(VIRTUALBOX_WORKINGDIR,defaultWorkingDir);
  IMedium distroMedium=manager.getVBox().openMedium(workingDir + "/" + isoName,DVD,ReadOnly,forceOverwrite);
  Long memorySize=new Long(1024);
  ISession session=manager.getSessionObject();
  IMachine machine=manager.getVBox().findMachine(vmName);
  machine.lockMachine(session,Write);
  IMachine mutable=session.getMachine();
  mutable.setMemorySize(memorySize);
  mutable.saveSettings();
  session.unlockMachine();
  machine.lockMachine(session,Write);
  mutable=session.getMachine();
  mutable.addStorageController(controllerIDE,StorageBus.IDE);
  mutable.saveSettings();
  session.unlockMachine();
  String adminDiskPath=workingDir + "/" + adminDisk;
  if (new File(adminDiskPath).exists()) {
    new File(adminDiskPath).delete();
  }
  IMedium hd=manager.getVBox().createHardDisk(diskFormat,adminDiskPath);
  long size=4L * 1024L * 1024L* 1024L - 4L;
  IProgress storageCreation=hd.createBaseStorage(size,(long)MediumVariant.STANDARD.ordinal());
  storageCreation.waitForCompletion(-1);
  machine.lockMachine(session,Write);
  mutable=session.getMachine();
  mutable.attachDevice(controllerIDE,0,0,DeviceType.DVD,distroMedium);
  mutable.saveSettings();
  session.unlockMachine();
  machine.lockMachine(session,Write);
  mutable=session.getMachine();
  mutable.attachDevice(controllerIDE,0,1,DeviceType.HardDisk,hd);
  mutable.saveSettings();
  session.unlockMachine();
  machine.lockMachine(session,Write);
  mutable=session.getMachine();
  mutable.getNetworkAdapter(0l).setAttachmentType(NAT);
  machine.getNetworkAdapter(0l).getNatDriver().addRedirect("guestssh",TCP,"127.0.0.1",2222,"",22);
  mutable.getNetworkAdapter(0l).setEnabled(true);
  mutable.saveSettings();
  session.unlockMachine();
  String guestAdditionsDvd=workingDir + "/VBoxGuestAdditions_4.1.2.iso";
  IMedium guestAdditionsDvdMedium=manager.getVBox().openMedium(guestAdditionsDvd,DeviceType.DVD,AccessMode.ReadOnly,forceOverwrite);
  machine.lockMachine(session,Write);
  mutable=session.getMachine();
  mutable.attachDevice(controllerIDE,1,1,DeviceType.DVD,guestAdditionsDvdMedium);
  mutable.saveSettings();
  session.unlockMachine();
  IProgress prog=machine.launchVMProcess(session,"gui","");
  prog.waitForCompletion(-1);
  try {
    Thread.sleep(5000);
  }
 catch (  InterruptedException e) {
    propagate(e);
  }
  String installKeySequence=System.getProperty(VIRTUALBOX_INSTALLATION_KEY_SEQUENCE,defaultInstallSequence());
  sendKeyboardSequence(installKeySequence);
  session.unlockMachine();
  boolean sshDeamonIsRunning=false;
  while (!sshDeamonIsRunning) {
    try {
      if (runScriptOnNode(guestId,"id",wrapInInitScript(false)).getExitCode() == 0) {
        logger.debug("Got response from ssh daemon.");
        sshDeamonIsRunning=true;
      }
    }
 catch (    SshException e) {
      logger.debug("No response from ssh daemon...");
    }
  }
  logger.debug("Installation of image complete. Powering down...");
  machine.lockMachine(session,LockType.Shared);
  IProgress powerDownProgress=session.getConsole().powerDown();
  powerDownProgress.waitForCompletion(-1);
  session.unlockMachine();
  try {
    logger.debug("Stopping Jetty server...");
    server.stop();
    logger.debug("Jetty server stopped.");
  }
 catch (  Exception e) {
    logger.error(e,"Could not stop Jetty server.");
  }
  return vm;
}
