{
  ISession session=null;
  if (machine.getCurrentSnapshot() == null) {
    int retries=10;
    while (true) {
      try {
        session=manager.get().openMachineSession(machine);
        IProgress progress=session.getConsole().takeSnapshot(snapshotName,snapshotDesc);
        progress.waitForCompletion(-1);
        logger.debug("Snapshot %s (description: %s) taken from %s",snapshotName,snapshotDesc,machine.getName());
        break;
      }
 catch (      Exception e) {
        if (e.getMessage().contains("VirtualBox error: The object is not ready")) {
          retries--;
          if (retries == 0) {
            logger.error(e,"Problem creating snapshot (too many retries) %s (descripton: %s) from machine %s",snapshotName,snapshotDesc,machine.getName());
            throw Throwables.propagate(e);
          }
        }
        logger.error(e,"Problem creating snapshot %s (descripton: %s) from machine %s",snapshotName,snapshotDesc,machine.getName());
        throw Throwables.propagate(e);
      }
 finally {
        if (session != null) {
          session.unlockMachine();
        }
      }
    }
  }
  return machine.getCurrentSnapshot();
}
