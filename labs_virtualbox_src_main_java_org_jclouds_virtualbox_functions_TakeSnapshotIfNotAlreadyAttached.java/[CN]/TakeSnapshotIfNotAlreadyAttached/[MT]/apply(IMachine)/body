{
  ISession session=null;
  ISnapshot snap=machine.getCurrentSnapshot();
  if (snap == null) {
    try {
      session=manager.get().openMachineSession(machine);
      logger.debug("No snapshot available taking new one: %s (description: %s) taken from %s",snapshotName,snapshotDesc,machine.getName());
      int retries=10;
      while (true) {
        try {
          boolean paused=false;
          if (machine.getState() == MachineState.Running) {
            session.getConsole().pause();
            paused=true;
          }
          IProgress progress=session.getConsole().takeSnapshot(snapshotName,snapshotDesc);
          progress.waitForCompletion(-1);
          if (paused) {
            session.getConsole().resume();
          }
          snap=machine.getCurrentSnapshot();
          logger.debug("Snapshot %s (description: %s) taken from %s",snapshotName,snapshotDesc,machine.getName());
          break;
        }
 catch (        Exception e) {
          if (e.getMessage().contains("VirtualBox error: The object is not ready") || e.getMessage().contains("This machine does not have any snapshots")) {
            retries--;
            if (retries == 0) {
              logger.error(e,"Problem creating snapshot (too many retries) %s (descripton: %s) from machine %s",snapshotName,snapshotDesc,machine.getName());
              throw Throwables.propagate(e);
            }
            Thread.sleep(1000L);
            continue;
          }
          logger.error(e,"Problem creating snapshot %s (descripton: %s) from machine %s",snapshotName,snapshotDesc,machine.getName());
          throw Throwables.propagate(e);
        }
      }
    }
 catch (    Exception e) {
      Throwables.propagate(e);
    }
 finally {
      if (session != null) {
        manager.get().closeMachineSession(session);
      }
    }
  }
  return snap;
}
