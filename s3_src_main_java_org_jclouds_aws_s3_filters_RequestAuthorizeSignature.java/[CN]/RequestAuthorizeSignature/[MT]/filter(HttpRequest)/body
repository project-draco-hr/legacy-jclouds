{
  request.getHeaders().removeAll(S3Constants.AUTH);
  request.getHeaders().removeAll(HttpConstants.CONTENT_TYPE);
  StringBuilder toSign=new StringBuilder();
  if (request.getContent() != null && request.getContentType() != null) {
    request.getHeaders().put(HttpConstants.CONTENT_TYPE,request.getContentType());
  }
  toSign.append(request.getMethod()).append("\n");
  request.getHeaders().put(HttpConstants.DATE,dateService.timestampAsHeaderString());
  for (  String header : firstHeadersToSign)   toSign.append(valueOrEmpty(request.getHeaders().get(header))).append("\n");
  for (  String header : request.getHeaders().keySet()) {
    if (header.startsWith("x-amz-")) {
      toSign.append(header).append(":");
      for (      String value : request.getHeaders().get(header))       toSign.append(value.replaceAll("\r?\n"," ")).append(",");
      toSign.deleteCharAt(toSign.lastIndexOf(","));
      toSign.append("\n");
    }
  }
  String hostHeader=request.getHeaders().get(HttpConstants.HOST).iterator().next();
  if (hostHeader.endsWith(".s3.amazonaws.com"))   toSign.append("/").append(hostHeader.substring(0,hostHeader.length() - 17));
  toSign.append(request.getUri());
  String signature;
  try {
    signature=S3Utils.digest(toSign.toString(),secretKey.getBytes());
  }
 catch (  Exception e) {
    throw new HttpException("error signing request",e);
  }
  request.getHeaders().put("Authorization","AWS " + accessKey + ":"+ signature);
}
