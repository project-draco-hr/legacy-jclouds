{
  try {
    IMachine machine=getVmWithGuestAdditionsInstalled();
    machineUtils.applyForMachine(machine.getName(),new LaunchMachineIfNotAlreadyRunning(manager.get(),ExecutionType.GUI,""));
    assertTrue(machineUtils.sharedLockMachineAndApplyToSession(machine.getName(),new Function<ISession,Boolean>(){
      @Override public Boolean apply(      ISession session){
        return session.getMachine().getGuestPropertyValue("/VirtualBox/GuestAdd/Version") != null;
      }
    }
));
  }
  finally {
    for (    VmSpec spec : ImmutableSet.of(sourceMachineSpec.getVmSpec())) {
      machineController.ensureMachineHasPowerDown(spec.getVmName());
      undoVm(spec);
    }
  }
}
