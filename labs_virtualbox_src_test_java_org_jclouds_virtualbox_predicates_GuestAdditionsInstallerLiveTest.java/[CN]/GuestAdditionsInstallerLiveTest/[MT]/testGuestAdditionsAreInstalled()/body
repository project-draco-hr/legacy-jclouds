{
  IMachine machine=null;
  try {
    machine=cloneFromMaster();
    machineController.ensureMachineIsLaunched(machine.getName());
    sshClientForIMachine=injector.getInstance(IMachineToSshClient.class);
    SshClient client=sshClientForIMachine.apply(machine);
    sshResponds=injector.getInstance(SshResponds.class);
    checkState(sshResponds.apply(client),"timed out waiting for guest %s to be accessible via ssh",machine.getName());
    ipAddressesLoadingCache=injector.getInstance(IpAddressesLoadingCache.class);
    assertTrue(MachineUtils.isIpv4(ipAddressesLoadingCache.apply(machine.getName())));
  }
  finally {
    for (    String vmNameOrId : ImmutableSet.of(machine.getName())) {
      machineController.ensureMachineHasPowerDown(vmNameOrId);
      undoVm(vmNameOrId);
    }
  }
}
