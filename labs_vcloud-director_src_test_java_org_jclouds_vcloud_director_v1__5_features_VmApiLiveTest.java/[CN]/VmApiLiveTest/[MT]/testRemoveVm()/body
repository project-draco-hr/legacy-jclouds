{
  VApp remove=instantiateVApp();
  DeployVAppParams params=DeployVAppParams.builder().deploymentLeaseSeconds((int)TimeUnit.SECONDS.convert(1L,TimeUnit.HOURS)).notForceCustomization().powerOn().build();
  Task deployVApp=vAppApi.deploy(remove.getHref(),params);
  assertTaskSucceedsLong(deployVApp);
  remove=vAppApi.getVApp(remove.getHref());
  List<Vm> vms=remove.getChildren().getVms();
  Vm temp=Iterables.get(vms,0);
  if (vms.size() == 1) {
    UndeployVAppParams undeployParams=UndeployVAppParams.builder().build();
    Task shutdownVapp=vAppApi.undeploy(remove.getHref(),undeployParams);
    assertTaskSucceedsLong(shutdownVapp);
  }
 else {
    powerOffVm(temp.getHref());
  }
  Task removeVm=vmApi.remove(temp.getHref());
  assertTrue(retryTaskSuccess.apply(removeVm),String.format(TASK_COMPLETE_TIMELY,"removeVm"));
  Vm removed=vmApi.get(temp.getHref());
  assertNull(removed,"The Vm " + temp.getName() + " should have been removed");
}
