{
  checkNotNull(backendNodeMetadata);
  checkNotNull(userGroup);
  checkNotNull(userOptions);
  checkNotNull(userOptions.getLoginUser());
  checkState(userOptions.getLoginPassword() != null || userOptions.getLoginPrivateKey() != null);
  JsonUserNodeMetadata jsonMetadata=new JsonUserNodeMetadata();
  jsonMetadata.user=userOptions.getLoginUser();
  jsonMetadata.password=userOptions.getLoginPassword();
  jsonMetadata.privateKey=userOptions.getLoginPrivateKey();
  jsonMetadata.authenticateSudo=userOptions.shouldAuthenticateSudo() != null ? userOptions.shouldAuthenticateSudo().booleanValue() : false;
  jsonMetadata.userMetadata=userOptions.getUserMetadata();
  jsonMetadata.tags=userOptions.getTags();
  jsonMetadata.group=userGroup;
  storage.get().put(backendNodeMetadata.getId(),Strings2.toInputStream(json.toJson(jsonMetadata)));
  return buildFromJsonAndBackendMetadata(backendNodeMetadata,jsonMetadata);
}
