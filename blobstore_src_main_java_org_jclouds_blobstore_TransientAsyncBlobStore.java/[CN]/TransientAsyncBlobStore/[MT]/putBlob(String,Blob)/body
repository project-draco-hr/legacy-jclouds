{
  Map<String,Blob> container=getContainerToBlobs().get(containerName);
  if (container == null) {
    new RuntimeException("containerName not found: " + containerName);
  }
  ByteArrayPayload payload=(object.getPayload() instanceof ByteArrayPayload) ? ByteArrayPayload.class.cast(object.getPayload()) : null;
  if (payload == null)   payload=(object.getPayload() instanceof DelegatingPayload) ? (DelegatingPayload.class.cast(object.getPayload()).getDelegate() instanceof ByteArrayPayload) ? ByteArrayPayload.class.cast(DelegatingPayload.class.cast(object.getPayload()).getDelegate()) : null : null;
  if (payload == null || !(payload instanceof ByteArrayPayload)) {
    InputStream input=object.getPayload().getInput();
    try {
      String oldContentType=object.getPayload().getContentType();
      payload=encryptionService.generatePayloadWithMD5For(input);
      payload.setContentType(oldContentType);
    }
  finally {
      Closeables.closeQuietly(input);
    }
  }
 else {
    if (payload.getContentMD5() == null)     payload=(ByteArrayPayload)encryptionService.generateMD5BufferingIfNotRepeatable(payload);
  }
  Blob blob=blobFactory.create(copy(object.getMetadata()));
  blob.setPayload(payload);
  blob.getMetadata().setLastModified(new Date());
  blob.getMetadata().setSize(payload.getContentLength());
  blob.getMetadata().setContentMD5(payload.getContentMD5());
  blob.getMetadata().setContentType(payload.getContentType());
  String eTag=encryptionService.hex(payload.getContentMD5());
  blob.getMetadata().setETag(eTag);
  container.put(blob.getMetadata().getName(),blob);
  blob.getAllHeaders().put(HttpHeaders.LAST_MODIFIED,dateService.rfc822DateFormat(blob.getMetadata().getLastModified()));
  blob.getAllHeaders().put(HttpHeaders.ETAG,eTag);
  blob.getAllHeaders().put(HttpHeaders.CONTENT_TYPE,payload.getContentType());
  blob.getAllHeaders().put(HttpHeaders.CONTENT_LENGTH,payload.getContentLength() + "");
  blob.getAllHeaders().put("Content-MD5",encryptionService.base64(payload.getContentMD5()));
  blob.getAllHeaders().putAll(Multimaps.forMap(blob.getMetadata().getUserMetadata()));
  return immediateFuture(eTag);
}
