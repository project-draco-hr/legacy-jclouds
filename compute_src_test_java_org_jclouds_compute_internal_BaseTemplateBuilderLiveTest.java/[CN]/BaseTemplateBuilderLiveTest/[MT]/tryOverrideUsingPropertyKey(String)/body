{
  Module credentialStoreModule=new CredentialStoreModule(new CopyInputStreamInputSupplierMap(new ConcurrentHashMap<String,InputSupplier<InputStream>>()));
  ComputeServiceContext context=null;
  try {
    Properties overrides=setupProperties();
    String login=loginUser != null ? loginUser : "foo:bar";
    overrides.setProperty(propertyKey + ".image.login-user",login);
    boolean auth=authenticateSudo != null ? Boolean.valueOf(authenticateSudo) : true;
    overrides.setProperty(propertyKey + ".image.authenticate-sudo",auth + "");
    context=createContext(overrides,ImmutableSet.<Module>of(credentialStoreModule));
    Iterable<String> userPass=Splitter.on(':').split(login);
    String user=Iterables.get(userPass,0);
    String pass=Iterables.size(userPass) > 1 ? Iterables.get(userPass,1) : null;
    assertEquals(context.getComputeService().templateBuilder().build().getImage().getDefaultCredentials(),LoginCredentials.builder().user(user).password(pass).authenticateSudo(auth).build());
  }
  finally {
    if (context != null) {
      context.close();
    }
  }
}
