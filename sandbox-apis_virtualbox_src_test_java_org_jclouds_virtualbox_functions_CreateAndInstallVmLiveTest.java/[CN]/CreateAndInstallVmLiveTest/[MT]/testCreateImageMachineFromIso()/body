{
  Injector injector=context.utils().injector();
  Function<String,String> configProperties=injector.getInstance(ValueOfConfigurationKeyOrNull.class);
  IMachineSpec machineSpec=IMachineSpec.builder().vm(vmSpecification).iso(IsoSpec.builder().sourcePath(operatingSystemIso).installationScript(configProperties.apply(VIRTUALBOX_INSTALLATION_KEY_SEQUENCE).replace("HOSTNAME",vmSpecification.getVmName())).preConfiguration(preconfigurationUri).build()).network(NetworkSpec.builder().natNetworkAdapter(0,NatAdapter.builder().tcpRedirectRule("127.0.0.1",2222,"",22).build()).build()).build();
  IMachine imageMachine=injector.getInstance(CreateAndInstallVm.class).apply(machineSpec);
  IMachineToImage iMachineToImage=new IMachineToImage(manager,map);
  Image newImage=iMachineToImage.apply(imageMachine);
  Set<? extends Image> images=context.getComputeService().listImages();
  Iterable<String> imageIds=transform(images,extractId());
  assertTrue(any(imageIds,equalTo(newImage.getId())));
}
