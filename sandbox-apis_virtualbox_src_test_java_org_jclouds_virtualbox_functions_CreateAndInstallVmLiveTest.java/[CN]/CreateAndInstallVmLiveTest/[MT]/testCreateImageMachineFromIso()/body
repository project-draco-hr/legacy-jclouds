{
  VirtualBoxManager manager=(VirtualBoxManager)context.getProviderSpecificContext().getApi();
  ComputeServiceContext localHostContext=computeServiceForLocalhostAndGuest(hostId,"localhost",guestId,"localhost",new Credentials("toor","password"));
  Predicate<IPSocket> socketTester=new RetryablePredicate<IPSocket>(new InetSocketAddressConnect(),10,1,TimeUnit.SECONDS);
  IMachine imageMachine=new CreateAndInstallVm(manager,guestId,localHostContext,hostId,socketTester,"127.0.0.1",8080,HEADLESS).apply(vmSpecification);
  IMachineToImage iMachineToImage=new IMachineToImage(manager,map);
  Image newImage=iMachineToImage.apply(imageMachine);
  Set<? extends Image> images=context.getComputeService().listImages();
  Iterable<String> imageIds=transform(images,extractId());
  assertTrue(any(imageIds,equalTo(newImage.getId())));
}
