{
  if (nothingChangedExceptOptions()) {
    TemplateBuilder defaultTemplate=defaultTemplateProvider.get();
    if (options != null)     defaultTemplate.options(options);
    return defaultTemplate.build();
  }
  if (options == null)   options=optionsProvider.get();
  logger.debug(">> searching params(%s)",this);
  Set<? extends Image> images=getImages();
  if (location == null)   location=defaultLocation.get();
  Predicate<Image> imagePredicate=buildImagePredicate();
  Iterable<? extends Image> supportedImages=filter(images,imagePredicate);
  if (size(supportedImages) == 0) {
    if (imagePredicate == idPredicate) {
      throwNoSuchElementExceptionAfterLoggingImageIds(format("%s not found",idPredicate),images);
    }
 else {
      throwNoSuchElementExceptionAfterLoggingImageIds(format("no image matched predicate: %s",imagePredicate),images);
    }
  }
  Hardware hardware=resolveHardware(hardwareSorter(),supportedImages);
  Image image=resolveImage(hardware,supportedImages);
  logger.debug("<<   matched image(%s)",image.getId());
  return new TemplateImpl(image,hardware,location,options);
}
