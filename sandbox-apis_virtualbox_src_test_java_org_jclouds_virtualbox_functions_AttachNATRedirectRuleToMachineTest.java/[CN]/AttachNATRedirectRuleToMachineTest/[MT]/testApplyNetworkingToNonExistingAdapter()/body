{
  Long adapterId=0l;
  IMachine machine=createMock(IMachine.class);
  INetworkAdapter networkAdapter=createMock(INetworkAdapter.class);
  INATEngine natEngine=createMock(INATEngine.class);
  expect(machine.getNetworkAdapter(adapterId)).andReturn(networkAdapter);
  networkAdapter.setAttachmentType(NAT);
  expect(networkAdapter.getNatDriver()).andReturn(natEngine);
  natEngine.addRedirect("guestssh",TCP,"127.0.0.1",2222,"",22);
  networkAdapter.setEnabled(true);
  machine.saveSettings();
  replay(machine,networkAdapter,natEngine);
  new AttachNATRedirectRuleToMachine(adapterId,new RedirectRule(TCP,"127.0.0.1",2222,"",22)).apply(machine);
  verify(machine,networkAdapter,natEngine);
}
