{
  VirtualBoxManager manager=createMock(VirtualBoxManager.class);
  IVirtualBox vBox=createMock(IVirtualBox.class);
  IMachine registeredMachine=createMock(IMachine.class);
  IProgress progress=createNiceMock(IProgress.class);
  List<IMedium> media=new ArrayList<IMedium>();
  List<IMedium> mediums=Collections.unmodifiableList(media);
  CleanupMode mode=CleanupMode.Full;
  String vmName="jclouds-image-example-machine-to-be-destroyed";
  String vmId="jclouds-image-iso-unregister";
  VmSpec vmSpecification=VmSpec.builder().id(vmId).name(vmName).memoryMB(512).cleanUpMode(mode).build();
  expect(manager.getVBox()).andReturn(vBox).anyTimes();
  expect(vBox.findMachine(vmName)).andReturn(registeredMachine);
  expect(registeredMachine.unregister(mode)).andReturn(mediums);
  expectLastCall().anyTimes();
  expect(registeredMachine.delete(mediums)).andReturn(progress);
  expectLastCall().anyTimes();
  replay(manager,vBox,registeredMachine,progress);
  new UnregisterMachineIfExistsAndDeleteItsMedia(manager).apply(vmSpecification);
}
