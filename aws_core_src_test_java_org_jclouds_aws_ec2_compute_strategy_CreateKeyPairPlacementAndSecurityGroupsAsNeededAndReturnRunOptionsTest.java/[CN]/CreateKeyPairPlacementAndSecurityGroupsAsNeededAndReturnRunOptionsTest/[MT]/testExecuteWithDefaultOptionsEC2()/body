{
  String region=Region.AP_SOUTHEAST_1;
  String tag="tag";
  Hardware size=EC2HardwareBuilder.m1_small().build();
  String systemGeneratedKeyPairName="systemGeneratedKeyPair";
  String generatedGroup="group";
  Set<String> generatedGroups=ImmutableSet.of(generatedGroup);
  CreateKeyPairPlacementAndSecurityGroupsAsNeededAndReturnRunOptions strategy=createMock(CreateKeyPairPlacementAndSecurityGroupsAsNeededAndReturnRunOptions.class,new Method[]{CreateKeyPairPlacementAndSecurityGroupsAsNeededAndReturnRunOptions.class.getDeclaredMethod("getProvider"),CreateKeyPairPlacementAndSecurityGroupsAsNeededAndReturnRunOptions.class.getDeclaredMethod("createNewKeyPairUnlessUserSpecifiedOtherwise",String.class,String.class,TemplateOptions.class),CreateKeyPairPlacementAndSecurityGroupsAsNeededAndReturnRunOptions.class.getDeclaredMethod("createNewPlacementGroupUnlessUserSpecifiedOtherwise",String.class,String.class,TemplateOptions.class),CreateKeyPairPlacementAndSecurityGroupsAsNeededAndReturnRunOptions.class.getDeclaredMethod("getSecurityGroupsForTagAndOptions",String.class,String.class,TemplateOptions.class)});
  EC2TemplateOptions options=createMock(EC2TemplateOptions.class);
  Template template=createMock(Template.class);
  expect(template.getHardware()).andReturn(size).atLeastOnce();
  expect(template.getOptions()).andReturn(options).atLeastOnce();
  expect(strategy.createNewKeyPairUnlessUserSpecifiedOtherwise(region,tag,options)).andReturn(systemGeneratedKeyPairName);
  expect(strategy.getSecurityGroupsForTagAndOptions(region,tag,options)).andReturn(generatedGroups);
  expect(strategy.getProvider()).andReturn("ec2");
  expect(options.getSubnetId()).andReturn(null);
  expect(options.getUserData()).andReturn(null);
  replay(options);
  replay(template);
  replay(strategy);
  RunInstancesOptions runOptions=strategy.execute(region,tag,template);
  assertEquals(runOptions.buildQueryParameters(),ImmutableMultimap.<String,String>of());
  assertEquals(runOptions.buildFormParameters().entries(),ImmutableMultimap.<String,String>of("InstanceType",size.getProviderId(),"AdditionalInfo",tag,"SecurityGroup.1",generatedGroup,"KeyName",systemGeneratedKeyPairName).entries());
  assertEquals(runOptions.buildMatrixParameters(),ImmutableMultimap.<String,String>of());
  assertEquals(runOptions.buildRequestHeaders(),ImmutableMultimap.<String,String>of());
  assertEquals(runOptions.buildStringPayload(),null);
  verify(options);
  verify(template);
  verify(strategy);
}
