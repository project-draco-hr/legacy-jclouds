{
  HttpNioFutureCommandConnectionHandle handle=(HttpNioFutureCommandConnectionHandle)context.removeAttribute("command-handle");
  if (handle != null) {
    try {
      HttpFutureCommand<?> command=handle.getCommand();
      int code=response.getStatusLine().getStatusCode();
      if ((code >= 200 && code < 300) || code == 404) {
        processResponse(response,command);
      }
 else {
        if (isRetryable(response)) {
          commandQueue.add(command);
        }
 else {
          commandFailed(command);
        }
      }
    }
  finally {
      releaseConnectionToPool(handle);
    }
  }
 else {
    throw new IllegalStateException(String.format("No command-handle associated with command %1s",context));
  }
}
