{
  String imageId="ami-1fd73376";
  RunningInstance server=null;
  while (server == null) {
    try {
      System.out.printf("%d: running instance%n",System.currentTimeMillis());
      server=client.getInstanceServices().runInstances(imageId,1,1,withKeyName(keyPair.getKeyName()).asType(InstanceType.M1_SMALL).withSecurityGroup(securityGroupName)).getRunningInstances().iterator().next();
    }
 catch (    HttpResponseException htpe) {
      if (htpe.getResponse().getStatusCode() == 400)       continue;
      throw htpe;
    }
  }
  assertNotNull(server.getInstanceId());
  serverId=server.getInstanceId();
  assertEquals(server.getInstanceState(),InstanceState.PENDING);
  server=blockUntilRunningInstanceActive(serverId);
  sshPing(server);
  System.out.printf("%d: %s ssh connection made%n",System.currentTimeMillis(),serverId);
}
