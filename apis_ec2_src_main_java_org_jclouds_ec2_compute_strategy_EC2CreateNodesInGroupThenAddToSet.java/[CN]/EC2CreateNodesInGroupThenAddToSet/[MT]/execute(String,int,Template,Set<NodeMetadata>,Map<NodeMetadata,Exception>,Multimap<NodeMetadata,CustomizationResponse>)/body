{
  Template mutableTemplate;
  if (template.getImage() != null && template.getImage().getId() != null) {
    mutableTemplate=templateBuilderProvider.get().imageId(template.getImage().getId()).fromTemplate(template).build();
  }
 else {
    mutableTemplate=templateBuilderProvider.get().fromTemplate(template).build();
  }
  Iterable<String> ips=allocateElasticIpsInRegion(count,template);
  Iterable<? extends RunningInstance> started=createKeyPairAndSecurityGroupsAsNeededThenRunInstances(group,count,mutableTemplate);
  Iterable<RegionAndName> ids=transform(started,instanceToRegionAndName);
  String idsString=Joiner.on(',').join(ids);
  if (Iterables.size(ids) > 0) {
    logger.debug("<< started instances(%s)",idsString);
    all(ids,instancePresent);
    logger.debug("<< present instances(%s)",idsString);
    populateCredentials(started);
  }
  assignElasticIpsToInstances(ips,started);
  return utils.customizeNodesAndAddToGoodMapOrPutExceptionIntoBadMap(mutableTemplate.getOptions(),transform(started,runningInstanceToNodeMetadata),goodNodes,badNodes,customizationResponses);
}
