{
  String ami=checkNotNull(imageAmiIdMap.get(image),"image not supported: " + image);
  InstanceType type=checkNotNull(profileInstanceTypeMap.get(profile),"profile not supported: " + profile);
  KeyPair keyPair=createKeyPair(name);
  String securityGroupName=name;
  createSecurityGroup(securityGroupName,22,80,8080,443);
  String script=new ScriptBuilder().addStatement(exec("runurl run.alestic.com/apt/upgrade")).addStatement(exec("apt-get install -y openjdk-6-jdk")).build(OsFamily.UNIX);
  logger.debug(">> running instance ami(%s) type(%s) keyPair(%s) securityGroup(%s)",ami,type,keyPair.getKeyName(),securityGroupName);
  RunningInstance runningInstance=Iterables.getLast(ec2Client.getInstanceServices().runInstancesInRegion(Region.DEFAULT,null,ami,1,1,withKeyName(keyPair.getKeyName()).asType(type).withSecurityGroup(securityGroupName).withAdditionalInfo(name).withUserData(script.getBytes())).getRunningInstances());
  logger.debug("<< started instance(%s)",runningInstance.getId());
  instanceStateRunning.apply(runningInstance);
  logger.debug("<< running instance(%s)",runningInstance.getId());
  runningInstance=getRunningInstance(runningInstance.getId());
  Set<InetAddress> publicAddresses=runningInstance.getIpAddress() == null ? ImmutableSet.<InetAddress>of() : ImmutableSet.<InetAddress>of(runningInstance.getIpAddress());
  Set<InetAddress> privateAddresses=runningInstance.getPrivateIpAddress() == null ? ImmutableSet.<InetAddress>of() : ImmutableSet.<InetAddress>of(runningInstance.getPrivateIpAddress());
  return new CreateServerResponseImpl(runningInstance.getId(),name,instanceToServerState.get(runningInstance.getInstanceState()),publicAddresses,privateAddresses,22,LoginType.SSH,new Credentials("root",keyPair.getKeyMaterial()));
}
