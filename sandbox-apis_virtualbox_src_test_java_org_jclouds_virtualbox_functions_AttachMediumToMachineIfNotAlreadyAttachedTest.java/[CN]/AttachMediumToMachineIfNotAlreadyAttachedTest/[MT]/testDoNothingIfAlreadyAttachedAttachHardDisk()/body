{
  String controllerName="IDE Controller";
  int controllerPort=0;
  int deviceSlot=1;
  VirtualBoxManager manager=createNiceMock(VirtualBoxManager.class);
  IMachine machine=createMock(IMachine.class);
  IVirtualBox vBox=createMock(IVirtualBox.class);
  IMedium hardDisk=createNiceMock(IMedium.class);
  final StringBuilder errorBuilder=new StringBuilder();
  errorBuilder.append("VirtualBox error: ");
  errorBuilder.append("Medium '/Users/mattias/jclouds-virtualbox-test/testadmin.vdi' ");
  errorBuilder.append("is already attached to port 0, device 1 of controller 'IDE Controller' ");
  errorBuilder.append("of this virtual machine (0x80BB000C)");
  String isoAlreadyAttachedException=errorBuilder.toString();
  VBoxException isoAttachedException=new VBoxException(createNiceMock(Throwable.class),isoAlreadyAttachedException);
  machine.attachDevice(controllerName,controllerPort,deviceSlot,DeviceType.HardDisk,hardDisk);
  expectLastCall().andThrow(isoAttachedException);
  replay(manager,machine,vBox,hardDisk);
  StorageController controller=StorageController.builder().name(controllerName).bus(StorageBus.IDE).attachHardDisk(HardDisk.builder().diskpath("/Users/mattias/jclouds-virtualbox-test/testadmin.vdi").controllerPort(controllerPort).deviceSlot(deviceSlot).build()).build();
  DeviceDetails deviceDetails=getOnlyElement(controller.getHardDisks()).getDeviceDetails();
  new AttachMediumToMachineIfNotAlreadyAttached(deviceDetails,hardDisk,controllerName).apply(machine);
  verify(machine);
}
