{
  String controllerName="IDE Controller";
  String diskPath="/Users/johndoe/jclouds-virtualbox-images/admin.vdi";
  String diskName="admin";
  String diskFormat="vdi";
  int controllerPort=0;
  int device=1;
  VirtualBoxManager manager=createNiceMock(VirtualBoxManager.class);
  IMachine machine=createMock(IMachine.class);
  IVirtualBox vBox=createMock(IVirtualBox.class);
  IMedium hardDisk=createNiceMock(IMedium.class);
  IProgress progress=createNiceMock(IProgress.class);
  expect(manager.getVBox()).andReturn(vBox).anyTimes();
  expect(vBox.createHardDisk(diskFormat,diskPath)).andReturn(hardDisk);
  expect(hardDisk.createBaseStorage(anyLong(),anyLong())).andReturn(progress);
  machine.attachDevice(controllerName,controllerPort,device,HardDisk,hardDisk);
  machine.saveSettings();
  replay(manager,machine,vBox,hardDisk);
  StorageController controller=StorageController.builder().name(controllerName).bus(StorageBus.IDE).attachHardDisk(controllerPort,device,diskPath,diskName).build();
  DeviceDetails deviceDetails=getOnlyElement(controller.getHardDisks()).getDeviceDetails();
  new AttachMediumToMachineIfNotAlreadyAttached(deviceDetails,hardDisk,controllerName).apply(machine);
  verify(machine);
}
