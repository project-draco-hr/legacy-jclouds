{
  try {
    List<S3Object> jsObjects=new ArrayList<S3Object>();
    List<String> commonPrefixes=new ArrayList<String>();
    ListBucketResponse jcBucket=null;
    do {
      ListBucketOptions options=Util.convertListObjectOptions(prefix,priorLastKey,delimiter,(int)maxListingLength);
      jcBucket=connection.listBucket(bucketName,options);
      jsObjects.addAll(Arrays.asList(Util.convertObjectHeads(jcBucket)));
      commonPrefixes.addAll(jcBucket.getCommonPrefixes());
      if (jcBucket.isTruncated()) {
        priorLastKey=jsObjects.get(jsObjects.size() - 1).getKey();
      }
 else {
        priorLastKey=null;
      }
    }
 while (completeListing && jcBucket.isTruncated());
    return new S3ObjectsChunk(prefix,jcBucket.getDelimiter(),(S3Object[])jsObjects.toArray(new S3Object[jsObjects.size()]),(String[])commonPrefixes.toArray(new String[commonPrefixes.size()]),priorLastKey);
  }
 catch (  Exception e) {
    Throwables.propagateIfPossible(e,S3ServiceException.class);
    throw new S3ServiceException("error listing objects in bucket " + bucketName,e);
  }
}
