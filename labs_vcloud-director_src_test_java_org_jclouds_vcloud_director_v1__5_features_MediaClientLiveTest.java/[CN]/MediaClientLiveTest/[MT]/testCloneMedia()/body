{
  oldMedia=media;
  media=vdcClient.cloneMedia(vdcUri,CloneMediaParams.builder().source(Reference.builder().fromEntity(media).build()).name("copied test media").description("copied by testCloneMedia()").build());
  Checks.checkMediaFor(VDC,media);
  if (media.getTasksInProgress() != null) {
    Task copyTask=Iterables.getFirst(media.getTasksInProgress().getTasks(),null);
    if (copyTask != null) {
      Checks.checkTask(copyTask);
      assertTrue(retryTaskSuccess.apply(copyTask),String.format(TASK_COMPLETE_TIMELY,"copyTask"));
      media=mediaClient.getMedia(media.getHref());
    }
  }
  Checks.checkMediaFor(MEDIA,media);
  assertTrue(media.clone(oldMedia),String.format(OBJ_FIELD_CLONE,MEDIA,"copied media",media.toString(),oldMedia.toString()));
  mediaClient.getMetadataClient().setMetadata(media.getHref(),"key",MetadataValue.builder().value("value").build());
  media=vdcClient.cloneMedia(vdcUri,CloneMediaParams.builder().source(Reference.builder().fromEntity(media).build()).name("moved test media").description("moved by testCloneMedia()").isSourceDelete(true).build());
  Checks.checkMediaFor(VDC,media);
  if (media.getTasksInProgress() != null) {
    Task copyTask=Iterables.getFirst(media.getTasksInProgress().getTasks(),null);
    if (copyTask != null) {
      Checks.checkTask(copyTask);
      assertTrue(retryTaskSuccess.apply(copyTask),String.format(TASK_COMPLETE_TIMELY,"copyTask"));
      media=mediaClient.getMedia(media.getHref());
    }
  }
  Checks.checkMediaFor(MEDIA,media);
  assertTrue(media.clone(oldMedia),String.format(OBJ_FIELD_CLONE,MEDIA,"moved media",media.toString(),oldMedia.toString()));
}
