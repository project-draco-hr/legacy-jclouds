{
  try {
    IMachine source=getSourceNode();
    if (source.getCurrentSnapshot() != null) {
      ISession session=manager.get().openMachineSession(source);
      session.getConsole().deleteSnapshot(source.getCurrentSnapshot().getId());
      session.unlockMachine();
    }
    IMachine clone=new CloneAndRegisterMachineFromIMachineIfNotAlreadyExists(manager,workingDir,clonedVmSpec,IS_LINKED_CLONE).apply(source);
    assertEquals(clone.getName(),clonedVmSpec.getVmName());
  }
  finally {
    for (    VmSpec spec : ImmutableSet.of(clonedVmSpec,sourceMachineSpec.getVmSpec()))     undoVm(spec);
  }
}
