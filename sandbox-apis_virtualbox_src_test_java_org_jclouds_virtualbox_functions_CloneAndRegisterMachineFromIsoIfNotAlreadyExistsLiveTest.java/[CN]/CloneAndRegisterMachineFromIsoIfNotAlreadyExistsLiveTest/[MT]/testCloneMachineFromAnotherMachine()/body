{
  VirtualBoxManager manager=(VirtualBoxManager)context.getProviderSpecificContext().getApi();
  ComputeServiceContext localHostContext=computeServiceForLocalhostAndGuest(hostId,"localhost",guestId,"localhost",new Credentials("toor","password"));
  IMachine master=getMasterNode(manager,localHostContext);
  if (master.getCurrentSnapshot() != null) {
    ISession session=manager.openMachineSession(master);
    session.getConsole().deleteSnapshot(master.getCurrentSnapshot().getId());
    session.unlockMachine();
  }
  clonedVmSpec=VmSpec.builder().id(cloneName).name(cloneName).memoryMB(512).cleanUpMode(mode).forceOverwrite(true).build();
  IMachine clone=new CloneAndRegisterMachineFromIMachineIfNotAlreadyExists(manager,workingDir,clonedVmSpec,IS_LINKED_CLONE).apply(master);
  assertEquals(clone.getName(),clonedVmSpec.getVmName());
  for (  VmSpec spec : ImmutableSet.of(clonedVmSpec,new IMachineToVmSpec().apply(master)))   lockMachineAndApplyOrReturnNullIfNotRegistered(manager,Write,spec.getVmName(),new UnregisterMachineIfExistsAndDeleteItsMedia(spec));
}
