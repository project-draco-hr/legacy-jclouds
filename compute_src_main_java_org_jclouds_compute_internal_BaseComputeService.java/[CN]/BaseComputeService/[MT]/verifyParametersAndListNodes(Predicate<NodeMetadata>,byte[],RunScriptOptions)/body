{
  checkNotNull(filter,"Filter must be provided");
  checkNotNull(runScript,"The script (represented by bytes array - use \"script\".getBytes() must be provided");
  checkNotNull(options,"options");
  Iterable<? extends NodeMetadata> nodes=Iterables.filter(detailsOnAllNodes(),filter);
  return Iterables.transform(nodes,new Function<NodeMetadata,NodeMetadata>(){
    @Override public NodeMetadata apply(    NodeMetadata node){
      checkArgument(node.getPublicAddresses().size() > 0,"no public ip addresses on node: " + node);
      if (options.getOverrideCredentials() != null) {
        node=installNewCredentials(node,options.getOverrideCredentials());
      }
 else {
        checkNotNull(node.getCredentials(),"If the default credentials need to be used, they can't be null");
        checkNotNull(node.getCredentials().identity,"Account name for ssh authentication must be " + "specified. Try passing RunScriptOptions with new credentials");
        checkNotNull(node.getCredentials().credential,"Key or password for ssh authentication must be " + "specified. Try passing RunScriptOptions with new credentials");
      }
      return node;
    }
  }
);
}
