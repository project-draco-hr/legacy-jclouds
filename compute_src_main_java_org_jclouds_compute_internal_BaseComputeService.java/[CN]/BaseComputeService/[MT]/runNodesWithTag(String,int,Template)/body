{
  checkNotNull(tag,"tag cannot be null");
  checkNotNull(template.getLocation(),"location");
  logger.debug(">> running %d node%s tag(%s) location(%s) image(%s) hardwareProfile(%s) options(%s)",count,count > 1 ? "s" : "",tag,template.getLocation().getId(),template.getImage().getId(),template.getHardware().getId(),template.getOptions());
  Set<NodeMetadata> nodes=newHashSet();
  Map<NodeMetadata,Exception> badNodes=newLinkedHashMap();
  Map<?,Future<Void>> responses=runNodesAndAddToSetStrategy.execute(tag,count,template,nodes,badNodes);
  Map<?,Exception> executionExceptions=awaitCompletion(responses,executor,null,logger,"resumeing nodes");
  for (  NodeMetadata node : concat(nodes,badNodes.keySet()))   if (node.getCredentials() != null)   credentialStore.put("node#" + node.getId(),node.getCredentials());
  if (executionExceptions.size() > 0 || badNodes.size() > 0) {
    throw new RunNodesException(tag,count,template,nodes,executionExceptions,badNodes);
  }
  return nodes;
}
