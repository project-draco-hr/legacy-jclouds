{
  checkArgument(tag.indexOf('-') == -1,"tag cannot contain hyphens");
  checkNotNull(template.getLocation(),"location");
  logger.debug(">> running %d node%s tag(%s) location(%s) image(%s) size(%s) options(%s)",count,count > 1 ? "s" : "",tag,template.getLocation().getId(),template.getImage().getId(),template.getSize().getId(),template.getOptions());
  final Set<NodeMetadata> nodes=Sets.newHashSet();
  Map<?,ListenableFuture<Void>> responses=runNodesAndAddToSetStrategy.execute(tag,count,template,nodes);
  Map<?,Exception> exceptions=awaitCompletion(responses,executor,null,logger,"starting nodes");
  if (exceptions.size() > 0 && template.getOptions().shouldDestroyOnError()) {
    ImmutableMap<?,? extends ComputeMetadata> currentNodes=Maps.uniqueIndex(listNodesStrategy.execute(),METADATA_TO_ID);
    for (    Entry<?,Exception> entry : exceptions.entrySet()) {
      logger.error(entry.getValue(),"<< error applying nodes(%s) [%s] destroying ",entry.getKey(),entry.getValue().getMessage());
      destroyNode(currentNodes.get(entry.getKey()));
    }
  }
  return Maps.uniqueIndex(nodes,METADATA_TO_ID);
}
