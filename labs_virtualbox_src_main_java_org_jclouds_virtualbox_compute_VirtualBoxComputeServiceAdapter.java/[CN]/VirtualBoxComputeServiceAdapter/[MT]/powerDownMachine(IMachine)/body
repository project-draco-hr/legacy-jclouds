{
  try {
    if (machine.getState() == MachineState.PoweredOff) {
      logger.debug("vm was already powered down: ",machine.getId());
      return;
    }
    logger.debug("powering down vm: ",machine.getId());
    ISession machineSession=manager.get().openMachineSession(machine);
    IProgress progress=machineSession.getConsole().powerDown();
    progress.waitForCompletion(-1);
    machineSession.unlockMachine();
    while (!machine.getSessionState().equals(SessionState.Unlocked)) {
      try {
        logger.info("waiting for unlocking session - session state: " + machine.getSessionState());
        Thread.sleep(1000);
      }
 catch (      InterruptedException e) {
      }
    }
  }
 catch (  Exception e) {
    throw Throwables.propagate(e);
  }
}
