{
  int retries=15;
  ISession session=checkNotNull(lockSession(machineId,type,retries),"session");
  try {
    return function.apply(session);
  }
 catch (  VBoxException e) {
    throw new RuntimeException(String.format("error applying %s to %s with %s lock: %s",function,machineId,type,e.getMessage()),e);
  }
 finally {
    if (type == LockType.Shared) {
      Uninterruptibles.sleepUninterruptibly(1,TimeUnit.SECONDS);
    }
    if (session.getState().equals(SessionState.Locked)) {
      session.unlockMachine();
    }
    if (!session.getState().equals(SessionState.Unlocked)) {
      checkSessionIsUnlocked(session,5,3L,TimeUnit.SECONDS);
    }
  }
}
