{
  int retries=5;
  int count=0;
  ISession session;
  long time=System.currentTimeMillis();
  while (true) {
    try {
      IMachine immutableMachine=manager.get().getVBox().findMachine(machineId);
      session=manager.get().getSessionObject();
      immutableMachine.lockMachine(session,type);
      System.err.println("ACQUIRED LOCK [" + time + "]");
      print();
      break;
    }
 catch (    VBoxException e) {
      VBoxException vbex=Throwables2.getFirstThrowableOfType(e,VBoxException.class);
      if (vbex != null && machineNotFoundException(vbex)) {
        return null;
      }
      count++;
      logger.warn(e,"Could not lock machine (try %d of %d). Error: %s",count,retries,e.getMessage());
      if (count == retries) {
        throw new RuntimeException(String.format("error locking %s with %s lock: %s",machineId,type,e.getMessage()),e);
      }
      try {
        Thread.sleep(1000L);
      }
 catch (      InterruptedException e1) {
      }
    }
  }
  try {
    return function.apply(session);
  }
 catch (  VBoxException e) {
    throw new RuntimeException(String.format("error applying %s to %s with %s lock: %s",function,machineId,type,e.getMessage()),e);
  }
 finally {
    session.unlockMachine();
    System.err.println("RELEASED LOCK [" + time + "]");
    print();
  }
}
