{
  int retries=5;
  ISession session=lockSession(machineId,type,retries);
  try {
    return function.apply(session);
  }
 catch (  VBoxException e) {
    throw new RuntimeException(String.format("error applying %s to %s with %s lock: %s",function,machineId,type,e.getMessage()),e);
  }
 finally {
    if (session != null && session.getState().equals(SessionState.Locked))     session.unlockMachine();
  }
}
