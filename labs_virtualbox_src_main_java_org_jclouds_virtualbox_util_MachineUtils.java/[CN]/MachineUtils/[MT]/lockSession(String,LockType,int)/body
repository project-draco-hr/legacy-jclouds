{
  int count=0;
  IMachine immutableMachine=manager.get().getVBox().findMachine(machineId);
  ISession session;
  while (true) {
    try {
      session=manager.get().getSessionObject();
      immutableMachine.lockMachine(session,type);
      break;
    }
 catch (    VBoxException e) {
      VBoxException vbex=Throwables2.getFirstThrowableOfType(e,VBoxException.class);
      if (vbex != null && machineNotFoundException(vbex)) {
        return null;
      }
      count++;
      logger.debug("Could not lock machine (try %d of %d). Error: %s",count,retries,e.getMessage());
      if (count == retries) {
        throw new RuntimeException(String.format("error locking %s with %s lock: %s",machineId,type,e.getMessage()),e);
      }
      Uninterruptibles.sleepUninterruptibly(1,TimeUnit.SECONDS);
    }
  }
  checkState(session.getState().equals(SessionState.Locked));
  return checkNotNull(session,"session");
}
