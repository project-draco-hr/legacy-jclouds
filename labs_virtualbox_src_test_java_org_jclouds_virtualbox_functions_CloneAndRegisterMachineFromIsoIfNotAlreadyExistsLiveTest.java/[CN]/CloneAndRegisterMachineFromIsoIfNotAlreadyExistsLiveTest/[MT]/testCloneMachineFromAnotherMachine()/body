{
  try {
    IMachine source=getSourceNode();
    if (source.getCurrentSnapshot() != null) {
      ISession session=manager.get().openMachineSession(source);
      session.getConsole().deleteSnapshot(source.getCurrentSnapshot().getId());
      session.unlockMachine();
    }
    IMachine clone=new CloneAndRegisterMachineFromIMachineIfNotAlreadyExists(manager,workingDir,cloneSpec,IS_LINKED_CLONE,machineUtils).apply(source);
    assertEquals(clone.getName(),cloneSpec.getVmSpec().getVmName());
  }
  finally {
    for (    VmSpec spec : ImmutableSet.of(cloneSpec.getVmSpec(),sourceMachineSpec.getVmSpec()))     undoVm(spec);
  }
}
