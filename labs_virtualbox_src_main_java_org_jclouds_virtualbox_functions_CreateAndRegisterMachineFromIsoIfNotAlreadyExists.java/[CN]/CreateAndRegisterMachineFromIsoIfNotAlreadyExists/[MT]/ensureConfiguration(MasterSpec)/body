{
  VmSpec vmSpec=machineSpec.getVmSpec();
  NetworkSpec networkSpec=machineSpec.getNetworkSpec();
  String vmName=vmSpec.getVmName();
  Map<Long,DeviceType> positionAndDeviceType=ImmutableMap.of(1l,DeviceType.HardDisk);
  ensureMachineHasDesiredBootOrder(vmName,positionAndDeviceType);
  ensureMachineHasMemory(vmName,vmSpec.getMemory());
  Set<StorageController> controllers=vmSpec.getControllers();
  if (controllers.isEmpty()) {
    throw new IllegalStateException(missingIDEControllersMessage(vmSpec));
  }
  StorageController controller=controllers.iterator().next();
  ensureMachineHasStorageControllerNamed(vmName,controller);
  setupHardDisksForController(vmName,controller);
  setupDvdsForController(vmSpec,vmName,controller);
  for (  NetworkInterfaceCard networkInterfaceCard : networkSpec.getNetworkInterfaceCards()) {
    new AttachNicToMachine(vmName,machineUtils).apply(networkInterfaceCard);
  }
}
