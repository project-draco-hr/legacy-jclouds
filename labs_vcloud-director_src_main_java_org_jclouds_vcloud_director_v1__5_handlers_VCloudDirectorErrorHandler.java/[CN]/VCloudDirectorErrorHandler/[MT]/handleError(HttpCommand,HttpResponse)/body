{
  byte[] data=closeClientButKeepContentStream(response);
  String message=data != null ? new String(data) : String.format("%s -> %s",command.getCurrentRequest().getRequestLine(),response.getStatusLine());
  Exception exception=new HttpResponseException(command,response,message);
  if (response.getPayload() != null && response.getPayload().getContentMetadata().getContentType().startsWith(VCloudDirectorMediaType.ERROR)) {
    try {
      Error error=JAXB.unmarshal(InputSuppliers.of(data).getInput(),Error.class);
      exception=new VCloudDirectorException(error);
      message=error.getMessage();
    }
 catch (    Exception e) {
      Throwables.propagate(e);
    }
  }
  if (response.getStatusCode() == 401) {
    exception=new AuthorizationException(message,exception);
  }
 else   if (response.getStatusCode() == 403 || response.getStatusCode() == 404) {
    exception=new ResourceNotFoundException(message,exception);
  }
  command.setException(exception);
}
