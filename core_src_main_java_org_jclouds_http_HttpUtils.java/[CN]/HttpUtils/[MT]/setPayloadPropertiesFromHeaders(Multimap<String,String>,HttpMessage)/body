{
  Payload payload=message.getPayload();
  boolean chunked=any(headers.entries(),new Predicate<Entry<String,String>>(){
    @Override public boolean apply(    Entry<String,String> input){
      return "Transfer-Encoding".equalsIgnoreCase(input.getKey()) && "chunked".equalsIgnoreCase(input.getValue());
    }
  }
);
  for (  Entry<String,String> header : headers.entries()) {
    if (!chunked && CONTENT_LENGTH.equalsIgnoreCase(header.getKey())) {
      if (payload != null)       payload.setContentLength(new Long(header.getValue()));
    }
 else     if ("Content-MD5".equalsIgnoreCase(header.getKey())) {
      if (payload != null)       payload.setContentMD5(encryptionService.fromBase64(header.getValue()));
    }
 else     if (CONTENT_TYPE.equalsIgnoreCase(header.getKey())) {
      if (payload != null)       payload.setContentType(header.getValue());
    }
 else {
      message.getHeaders().put(header.getKey(),header.getValue());
    }
  }
  if (message instanceof HttpRequest) {
    checkArgument(message.getPayload() == null || message.getFirstHeaderOrNull(CONTENT_TYPE) == null,"configuration error please use request.getPayload().setContentType(value) as opposed to adding a content type   header: " + message);
    checkArgument(message.getPayload() == null || message.getFirstHeaderOrNull(CONTENT_LENGTH) == null,"configuration error please use request.getPayload().setContentLength(value) as opposed to adding a content length header: " + message);
    checkArgument(message.getPayload() == null || message.getPayload().getContentLength() != null || "chunked".equalsIgnoreCase(message.getFirstHeaderOrNull("Transfer-Encoding")),"either chunked encoding must be set on the http request or contentlength set on the payload: " + message);
    checkArgument(message.getPayload() == null || message.getFirstHeaderOrNull("Content-MD5") == null,"configuration error please use request.getPayload().setContentMD5(value) as opposed to adding a content md5 header: " + message);
  }
}
