{
  Payload payload=message.getPayload();
  boolean chunked=any(headers.entries(),new Predicate<Entry<String,String>>(){
    @Override public boolean apply(    Entry<String,String> input){
      return "Transfer-Encoding".equalsIgnoreCase(input.getKey()) && "chunked".equalsIgnoreCase(input.getValue());
    }
  }
);
  for (  Entry<String,String> header : headers.entries()) {
    if (!chunked && CONTENT_LENGTH.equalsIgnoreCase(header.getKey())) {
      if (payload != null)       payload.getContentMetadata().setContentLength(new Long(header.getValue()));
    }
 else     if ("Content-MD5".equalsIgnoreCase(header.getKey())) {
      if (payload != null)       payload.getContentMetadata().setContentMD5(CryptoStreams.base64(header.getValue()));
    }
 else     if (CONTENT_TYPE.equalsIgnoreCase(header.getKey())) {
      if (payload != null)       payload.getContentMetadata().setContentType(header.getValue());
    }
 else     if ("Content-Disposition".equalsIgnoreCase(header.getKey())) {
      if (payload != null)       payload.getContentMetadata().setContentDisposition(header.getValue());
    }
 else     if ("Content-Encoding".equalsIgnoreCase(header.getKey())) {
      if (payload != null)       payload.getContentMetadata().setContentEncoding(header.getValue());
    }
 else     if ("Content-Language".equalsIgnoreCase(header.getKey())) {
      if (payload != null)       payload.getContentMetadata().setContentLanguage(header.getValue());
    }
 else {
      message.getHeaders().put(header.getKey(),header.getValue());
    }
  }
  if (message instanceof HttpRequest) {
    checkArgument(message.getPayload() == null || message.getFirstHeaderOrNull(CONTENT_TYPE) == null,"configuration error please use request.getPayload().getContentMetadata().setContentType(value) as opposed to adding a content type header: " + message);
    checkArgument(message.getPayload() == null || message.getFirstHeaderOrNull(CONTENT_LENGTH) == null,"configuration error please use request.getPayload().getContentMetadata().setContentLength(value) as opposed to adding a content length header: " + message);
    checkArgument(message.getPayload() == null || message.getPayload().getContentMetadata().getContentLength() != null || "chunked".equalsIgnoreCase(message.getFirstHeaderOrNull("Transfer-Encoding")),"either chunked encoding must be set on the http request or contentlength set on the payload: " + message);
    checkArgument(message.getPayload() == null || message.getFirstHeaderOrNull("Content-MD5") == null,"configuration error please use request.getPayload().getContentMetadata().setContentMD5(value) as opposed to adding a content md5 header: " + message);
    checkArgument(message.getPayload() == null || message.getFirstHeaderOrNull("Content-Disposition") == null,"configuration error please use request.getPayload().getContentMetadata().setContentDisposition(value) as opposed to adding a content disposition header: " + message);
    checkArgument(message.getPayload() == null || message.getFirstHeaderOrNull(CONTENT_ENCODING) == null,"configuration error please use request.getPayload().getContentMetadata().setContentEncoding(value) as opposed to adding a content encoding header: " + message);
    checkArgument(message.getPayload() == null || message.getFirstHeaderOrNull(CONTENT_LANGUAGE) == null,"configuration error please use request.getPayload().getContentMetadata().setContentLanguage(value) as opposed to adding a content language header: " + message);
  }
}
