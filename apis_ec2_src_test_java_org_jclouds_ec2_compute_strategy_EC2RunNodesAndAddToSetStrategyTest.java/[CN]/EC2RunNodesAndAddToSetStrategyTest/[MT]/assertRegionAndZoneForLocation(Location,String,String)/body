{
  String imageId="ami1";
  String instanceCreatedId="instance1";
  EC2RunNodesAndAddToSetStrategy strategy=setupStrategy();
  InputParams input=new InputParams(location);
  InstanceClient instanceClient=createMock(InstanceClient.class);
  RunInstancesOptions ec2Options=createMock(RunInstancesOptions.class);
  RunningInstance instance=createMock(RunningInstance.class);
  Reservation<? extends RunningInstance> reservation=new Reservation<RunningInstance>(region,ImmutableSet.<String>of(),ImmutableSet.<RunningInstance>of(instance),"ownerId","requesterId","reservationId");
  NodeMetadata nodeMetadata=createMock(NodeMetadata.class);
  expect(strategy.client.getInstanceServices()).andReturn(instanceClient).atLeastOnce();
  expect(strategy.createKeyPairAndSecurityGroupsAsNeededAndReturnRunOptions.execute(region,input.tag,input.template)).andReturn(ec2Options);
  expect(input.template.getLocation()).andReturn(input.location).atLeastOnce();
  expect(input.template.getImage()).andReturn(input.image).atLeastOnce();
  expect(input.image.getProviderId()).andReturn(imageId).atLeastOnce();
  expect(instanceClient.runInstancesInRegion(region,zone,imageId,1,input.count,ec2Options)).andReturn((Reservation)reservation);
  expect(instance.getId()).andReturn(instanceCreatedId).atLeastOnce();
  Credentials creds=new Credentials("foo","bar");
  expect(strategy.instanceToCredentials.apply(instance)).andReturn(creds);
  expect(instance.getRegion()).andReturn(region);
  expect(strategy.credentialStore.put("node#" + region + "/"+ instanceCreatedId,creds)).andReturn(null);
  expect(strategy.instancePresent.apply(instance)).andReturn(true);
  expect(input.template.getOptions()).andReturn(input.options).atLeastOnce();
  expect(input.options.isMonitoringEnabled()).andReturn(false);
  expect(strategy.runningInstanceToNodeMetadata.apply(instance)).andReturn(nodeMetadata);
  expect(strategy.utils.runOptionsOnNodesAndAddToGoodSetOrPutExceptionIntoBadMap(eq(input.options),containsNodeMetadata(nodeMetadata),eq(input.nodes),eq(input.badNodes))).andReturn(null);
  replay(instanceClient);
  replay(ec2Options);
  replay(instance);
  replay(nodeMetadata);
  input.replayMe();
  replayStrategy(strategy);
  strategy.execute(input.tag,input.count,input.template,input.nodes,input.badNodes);
  verify(instanceClient);
  verify(ec2Options);
  verify(instance);
  verify(nodeMetadata);
  input.verifyMe();
  verifyStrategy(strategy);
}
