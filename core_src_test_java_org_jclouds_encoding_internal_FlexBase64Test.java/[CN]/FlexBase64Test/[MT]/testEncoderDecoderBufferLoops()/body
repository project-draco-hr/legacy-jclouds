{
  byte[] nums=new byte[32768];
  for (int i=0; i < 32768; i++) {
    nums[i]=(byte)(i % 255);
  }
  ByteBuffer source=ByteBuffer.wrap(nums);
  ByteBuffer target=ByteBuffer.allocate(65535);
  FlexBase64.Encoder encoder=FlexBase64.createEncoder(true);
  int limit=target.limit();
  target.limit(100);
  while (source.remaining() > 0) {
    encoder.encode(source,target);
    int add=limit - target.position();
    add=add < 100 ? add : 100;
    target.limit(target.limit() + add);
  }
  encoder.complete(target);
  ByteBuffer decoded=ByteBuffer.allocate(nums.length);
  FlexBase64.Decoder decoder=FlexBase64.createDecoder();
  target.flip();
  limit=decoded.limit();
  decoded.limit(100);
  while (target.remaining() > 0) {
    decoder.decode(target,decoded);
    int add=limit - decoded.position();
    add=add < 100 ? add : 100;
    decoded.limit(decoded.position() + add);
  }
  decoded.flip();
  Assert.assertEquals(nums.length,decoded.remaining());
  for (int i=0; i < nums.length; i++) {
    Assert.assertEquals(nums[i],decoded.get());
  }
}
