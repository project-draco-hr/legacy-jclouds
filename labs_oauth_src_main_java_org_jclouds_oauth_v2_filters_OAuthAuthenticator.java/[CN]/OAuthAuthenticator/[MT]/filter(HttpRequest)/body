{
  checkState(request instanceof GeneratedHttpRequest,"request must be an instance of GeneratedHttpRequest");
  GeneratedHttpRequest generatedHttpRequest=(GeneratedHttpRequest)request;
  TokenRequest tokenRequest=tokenRequestBuilder.apply(generatedHttpRequest);
  Token token=tokenFetcher.apply(tokenRequest);
  return request.toBuilder().addHeader("Authorization",String.format("%s %s",token.getTokenType(),token.getAccessToken())).build();
}
