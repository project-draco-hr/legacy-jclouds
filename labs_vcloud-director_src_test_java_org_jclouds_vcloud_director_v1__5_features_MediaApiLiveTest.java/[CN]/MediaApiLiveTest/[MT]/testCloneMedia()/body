{
  oldMedia=media;
  media=vdcApi.cloneMedia(vdcUrn,CloneMediaParams.builder().source(Reference.builder().fromEntity(media).build()).name("copied " + media.getName()).description("copied by testCloneMedia()").build());
  Checks.checkMediaFor(VDC,media);
  if (media.getTasks() != null) {
    Task copyTask=getFirst(media.getTasks(),null);
    if (copyTask != null) {
      Checks.checkTask(copyTask);
      assertTrue(retryTaskSuccess.apply(copyTask),String.format(TASK_COMPLETE_TIMELY,"copyTask"));
      media=mediaApi.getMedia(media.getHref());
    }
  }
  Checks.checkMediaFor(MEDIA,media);
  assertTrue(media.clone(oldMedia),String.format(OBJ_FIELD_CLONE,MEDIA,"copied media",media.toString(),oldMedia.toString()));
  mediaApi.getMetadataApi().putEntry(media.getHref(),"key",MetadataValue.builder().value("value").build());
  media=vdcApi.cloneMedia(vdcUrn,CloneMediaParams.builder().source(Reference.builder().fromEntity(media).build()).name("moved test media").description("moved by testCloneMedia()").isSourceDelete(true).build());
  Checks.checkMediaFor(VDC,media);
  if (media.getTasks() != null) {
    Task copyTask=getFirst(media.getTasks(),null);
    if (copyTask != null) {
      Checks.checkTask(copyTask);
      assertTrue(retryTaskSuccess.apply(copyTask),String.format(TASK_COMPLETE_TIMELY,"copyTask"));
      media=mediaApi.getMedia(media.getHref());
    }
  }
  Checks.checkMediaFor(MEDIA,media);
  assertTrue(media.clone(oldMedia),String.format(OBJ_FIELD_CLONE,MEDIA,"moved media",media.toString(),oldMedia.toString()));
}
