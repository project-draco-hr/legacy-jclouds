{
  Task mergeMetadata=context.getApi().getMetadataApi(media.getId()).putAll(ImmutableMap.of("testKey","testValue"));
  Checks.checkTask(mergeMetadata);
  assertTrue(retryTaskSuccess.apply(mergeMetadata),String.format(TASK_COMPLETE_TIMELY,"mergeMetadata(new)"));
  metadata=context.getApi().getMetadataApi(media.getId()).get();
  Checks.checkMetadataFor(MEDIA,metadata);
  assertEquals(metadata.get("testKey"),"testValue");
  media=mediaApi.get(media.getId());
  Checks.checkMediaFor(MEDIA,media);
  mergeMetadata=context.getApi().getMetadataApi(media.getId()).put("testKey","new testValue");
  Checks.checkTask(mergeMetadata);
  assertTrue(retryTaskSuccess.apply(mergeMetadata),String.format(TASK_COMPLETE_TIMELY,"mergeMetadata(edit)"));
  metadata=context.getApi().getMetadataApi(media.getId()).get();
  Checks.checkMetadataFor(MEDIA,metadata);
  assertEquals(metadata.get("testKey"),"new testValue");
  media=mediaApi.get(media.getId());
  Checks.checkMediaFor(MEDIA,media);
}
