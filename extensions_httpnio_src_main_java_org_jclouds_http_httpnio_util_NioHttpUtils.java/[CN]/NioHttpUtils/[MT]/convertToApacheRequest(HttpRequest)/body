{
  String path=request.getEndpoint().getRawPath();
  if (request.getEndpoint().getQuery() != null)   path+="?" + request.getEndpoint().getQuery();
  BasicHttpEntityEnclosingRequest apacheRequest=new BasicHttpEntityEnclosingRequest(request.getMethod(),path,HttpVersion.HTTP_1_1);
  Object content=request.getEntity();
  if (content != null) {
    String lengthString=request.getFirstHeaderOrNull(HttpHeaders.CONTENT_LENGTH);
    if (lengthString == null) {
      throw new IllegalStateException("no Content-Length header on request: " + apacheRequest);
    }
    long contentLength=Long.parseLong(lengthString);
    String contentType=request.getFirstHeaderOrNull(HttpHeaders.CONTENT_TYPE);
    addEntityForContent(apacheRequest,content,contentType,contentLength);
  }
  for (  String header : request.getHeaders().keySet()) {
    for (    String value : request.getHeaders().get(header))     if (!header.equals(HttpHeaders.CONTENT_LENGTH))     apacheRequest.addHeader(header,value);
  }
  return apacheRequest;
}
