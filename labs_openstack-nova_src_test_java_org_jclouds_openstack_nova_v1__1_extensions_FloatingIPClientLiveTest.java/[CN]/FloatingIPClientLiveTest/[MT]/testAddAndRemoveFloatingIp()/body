{
  for (  String regionId : context.getApi().getConfiguredRegions()) {
    Optional<FloatingIPClient> clientOption=context.getApi().getFloatingIPExtensionForRegion(regionId);
    if (!clientOption.isPresent())     continue;
    FloatingIPClient client=clientOption.get();
    ServerClient serverClient=context.getApi().getServerClientForRegion(regionId);
    Server server=serverClient.createServer("test",imageIdForRegion(regionId),flavorRefForRegion(regionId));
    blockUntilServerActive(server.getId(),serverClient);
    FloatingIP floatingIP=client.allocate();
    assertNotNull(floatingIP);
    try {
      client.addFloatingIP(server.getId(),floatingIP.getIp());
      assertEventually(new ServerHasFloatingIP(serverClient,server.getId(),floatingIP.getIp()));
    }
  finally {
      client.removeFloatingIP(server.getId(),floatingIP.getIp());
      serverClient.deleteServer(server.getId());
    }
  }
}
