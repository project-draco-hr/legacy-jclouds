{
  if (response.getStatusCode() == 301 || response.getStatusCode() == 307) {
    byte[] content=S3Utils.closeConnectionButKeepContentStream(response);
    if (command.getRequest().getMethod() == HttpMethod.HEAD) {
      command.getRequest().setMethod(HttpMethod.GET);
      return true;
    }
 else {
      command.incrementRedirectCount();
      try {
        AWSError error=S3Utils.parseAWSErrorFromContent(parserFactory,command,response,new String(content));
        String host=error.getDetails().get(S3Constants.ENDPOINT);
        if (host != null) {
          if (host.equals(command.getRequest().getEndPoint().getHost())) {
            try {
              command.incrementFailureCount();
              Thread.sleep(100);
              return true;
            }
 catch (            InterruptedException e) {
              command.setException(e);
              return false;
            }
          }
 else {
            URI endPoint=command.getRequest().getEndPoint();
            endPoint=Utils.replaceHostInEndPoint(endPoint,host);
            command.getRequest().setEndPoint(endPoint);
            command.getRequest().getHeaders().removeAll(HttpHeaders.HOST);
          }
          return true;
        }
 else {
          return false;
        }
      }
 catch (      HttpException e) {
        return false;
      }
    }
  }
 else {
    return super.shouldRetryRequest(command,response);
  }
}
