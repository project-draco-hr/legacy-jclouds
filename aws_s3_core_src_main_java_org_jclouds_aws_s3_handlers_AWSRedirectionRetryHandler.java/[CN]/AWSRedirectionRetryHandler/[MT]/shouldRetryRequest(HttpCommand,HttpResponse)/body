{
  if (response.getFirstHeaderOrNull(HttpHeaders.LOCATION) == null && (response.getStatusCode() == 301 || response.getStatusCode() == 307)) {
    byte[] content=Utils.closeClientButKeepContentStream(response);
    if (command.getRequest().getMethod() == HttpMethod.HEAD) {
      command.setMethod(HttpMethod.GET);
      return true;
    }
 else {
      command.incrementRedirectCount();
      try {
        AWSError error=utils.parseAWSErrorFromContent(command,response,new String(content));
        String host=error.getDetails().get(S3Constants.ENDPOINT);
        if (host != null) {
          if (host.equals(command.getRequest().getEndpoint().getHost())) {
            return backoffHandler.shouldRetryRequest(command,response);
          }
 else {
            command.setHostAndPort(host,command.getRequest().getEndpoint().getPort());
          }
          return true;
        }
 else {
          return false;
        }
      }
 catch (      HttpException e) {
        logger.error(e,"error on redirect for command %s; response %s; retrying...",command,response);
        return false;
      }
    }
  }
 else {
    return super.shouldRetryRequest(command,response);
  }
}
