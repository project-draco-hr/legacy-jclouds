{
  String id=checkNotNull(instance,"instance").getId();
  String name=null;
  URI uri=null;
  Credentials credentials=null;
  String tag=String.format("NOTAG-%s",instance.getId());
  if (instance.getKeyName() != null) {
    tag=instance.getKeyName().replaceAll("-[0-9]+","");
    credentials=new Credentials(getLoginAccountFor(instance),getPrivateKeyOrNull(instance,tag));
  }
  Map<String,String> userMetadata=ImmutableMap.<String,String>of();
  NodeState state=instanceToNodeState.get(instance.getInstanceState());
  Set<InetAddress> publicAddresses=nullSafeSet(instance.getIpAddress());
  Set<InetAddress> privateAddresses=nullSafeSet(instance.getPrivateIpAddress());
  final String locationId=instance.getAvailabilityZone();
  Map<String,String> extra=getExtra(instance);
  final Location location=Iterables.find(locations,new Predicate<Location>(){
    @Override public boolean apply(    Location input){
      return input.getId().equals(locationId);
    }
  }
);
  Image image=null;
  try {
    image=Iterables.find(images,new FindImageForInstance(location,instance));
  }
 catch (  NoSuchElementException e) {
    logger.warn("could not find a matching image for instance %s in location %s",instance,location);
  }
  return new NodeMetadataImpl(id,name,location,uri,userMetadata,tag,image,state,publicAddresses,privateAddresses,extra,credentials);
}
