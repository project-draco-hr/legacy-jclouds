{
  NodeMetadataBuilder builder=new NodeMetadataBuilder();
  String providerId=checkNotNull(instance,"instance").getId();
  builder.providerId(providerId);
  builder.id(instance.getRegion() + "/" + providerId);
  String tag=getTagForInstance(instance);
  builder.tag(tag);
  builder.credentials(credentialStore.get(instance.getRegion() + "/" + providerId));
  builder.state(instanceToNodeState.get(instance.getInstanceState()));
  builder.publicAddresses(nullSafeSet(instance.getIpAddress()));
  builder.privateAddresses(nullSafeSet(instance.getPrivateIpAddress()));
  builder.hardware(parseHardware(instance));
  Location location=getLocationForAvailabilityZoneOrRegion(instance);
  builder.location(location);
  builder.imageId(instance.getRegion() + "/" + instance.getImageId());
  Image image=instanceToImage.get(new RegionAndName(instance.getRegion(),instance.getImageId()));
  if (image != null)   builder.operatingSystem(image.getOperatingSystem());
  return builder.build();
}
