{
  String id=checkNotNull(instance,"instance").getId();
  String name=null;
  URI uri=null;
  String tag=getTagForInstance(instance);
  Credentials credentials=getCredentialsForInstanceWithTag(instance,tag);
  Map<String,String> userMetadata=ImmutableMap.<String,String>of();
  NodeState state=instanceToNodeState.get(instance.getInstanceState());
  Set<String> publicAddresses=nullSafeSet(instance.getIpAddress());
  Set<String> privateAddresses=nullSafeSet(instance.getPrivateIpAddress());
  Hardware hardware=getHardwareForInstance(instance);
  if (hardware != null) {
    hardware=ComputeServiceUtils.replacesVolumes(hardware,addEBS(instance,hardware.getVolumes()));
  }
  Location location=getLocationForAvailabilityZoneOrRegion(instance);
  Image image=resolveImageForInstanceInLocation(instance,location);
  return new NodeMetadataImpl(id,name,instance.getRegion() + "/" + instance.getId(),location,uri,userMetadata,tag,hardware,instance.getRegion() + "/" + instance.getImageId(),image != null ? image.getOperatingSystem() : null,state,publicAddresses,privateAddresses,credentials);
}
