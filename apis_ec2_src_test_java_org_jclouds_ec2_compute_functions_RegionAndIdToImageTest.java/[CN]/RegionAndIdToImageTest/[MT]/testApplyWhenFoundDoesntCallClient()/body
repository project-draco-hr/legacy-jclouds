{
  EC2ImageParser parser=createMock(EC2ImageParser.class);
  EC2Client caller=createMock(EC2Client.class);
  AMIClient client=createMock(AMIClient.class);
  Map<RegionAndName,Image> knownImages=createMock(Map.class);
  Image image=createNiceMock(Image.class);
  expect(knownImages.containsKey(new RegionAndName("region","ami"))).andReturn(true);
  expect(knownImages.get(new RegionAndName("region","ami"))).andReturn(image);
  replay(knownImages);
  replay(caller);
  replay(image);
  replay(parser);
  replay(client);
  RegionAndIdToImage function=new RegionAndIdToImage(knownImages,parser,caller);
  assertEquals(function.load(new RegionAndName("region","ami")),image);
  verify(caller);
  verify(image);
  verify(image);
  verify(knownImages);
  verify(client);
}
