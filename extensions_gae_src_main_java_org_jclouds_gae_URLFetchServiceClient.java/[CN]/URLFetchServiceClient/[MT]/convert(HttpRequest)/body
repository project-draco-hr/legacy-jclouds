{
  String hostHeader=request.getFirstHeaderOrNull(HttpConstants.HOST);
  URL url;
  if (hostHeader != null) {
    url=new URL(new URL(isSecure ? "https" : "http",hostHeader,port,"/"),request.getUri());
  }
 else {
    url=new URL(target,request.getUri());
  }
  FetchOptions options=disallowTruncate();
  followRedirectsUnlessRequestContainsPayload(request,options);
  HTTPRequest gaeRequest=new HTTPRequest(url,HTTPMethod.valueOf(request.getMethod()),options);
  for (  String header : request.getHeaders().keySet()) {
    if (!header.equals(HttpConstants.HOST)) {
      for (      String value : request.getHeaders().get(header)) {
        gaeRequest.addHeader(new HTTPHeader(header,value));
      }
    }
  }
  if (request.getPayload() != null) {
    changeRequestContentToBytes(request);
    gaeRequest.setPayload((byte[])request.getPayload());
  }
 else {
    gaeRequest.addHeader(new HTTPHeader(HttpConstants.CONTENT_LENGTH,"0"));
  }
  return gaeRequest;
}
