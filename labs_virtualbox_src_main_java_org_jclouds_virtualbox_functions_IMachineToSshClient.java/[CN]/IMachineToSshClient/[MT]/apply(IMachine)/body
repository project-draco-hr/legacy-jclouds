{
  INetworkAdapter networkAdapter=vm.getNetworkAdapter(0L);
  SshClient client=null;
  checkNotNull(networkAdapter);
  String clientIpAddress=null;
  String sshPort="22";
  String guestIdentity=vm.getExtraData(GUEST_OS_USER);
  String guestCredential=vm.getExtraData(GUEST_OS_PASSWORD);
  LoginCredentials loginCredentials=LoginCredentials.builder().user(guestIdentity).password(guestCredential).authenticateSudo(true).build();
  if (networkAdapter.getAttachmentType().equals(NetworkAttachmentType.NAT)) {
    for (    String nameProtocolnumberAddressInboundPortGuestTargetport : networkAdapter.getNatDriver().getRedirects()) {
      Iterable<String> stuff=Splitter.on(',').split(nameProtocolnumberAddressInboundPortGuestTargetport);
      String protocolNumber=Iterables.get(stuff,1);
      String hostAddress=Iterables.get(stuff,2);
      String inboundPort=Iterables.get(stuff,3);
      String targetPort=Iterables.get(stuff,5);
      if ("1".equals(protocolNumber) && "22".equals(targetPort)) {
        clientIpAddress=hostAddress;
        sshPort=inboundPort;
      }
    }
  }
 else   if (networkAdapter.getAttachmentType().equals(NetworkAttachmentType.Bridged)) {
    clientIpAddress=networkUtils.getIpAddressFromNicSlot(vm.getName(),networkAdapter.getSlot());
  }
 else   if (networkAdapter.getAttachmentType().equals(NetworkAttachmentType.HostOnly)) {
    clientIpAddress=networkUtils.getIpAddressFromNicSlot(vm.getName(),networkAdapter.getSlot());
  }
  checkNotNull(clientIpAddress,"clientIpAddress");
  client=sshClientFactory.create(HostAndPort.fromParts(clientIpAddress,Integer.parseInt(sshPort)),loginCredentials);
  checkNotNull(client);
  return client;
}
