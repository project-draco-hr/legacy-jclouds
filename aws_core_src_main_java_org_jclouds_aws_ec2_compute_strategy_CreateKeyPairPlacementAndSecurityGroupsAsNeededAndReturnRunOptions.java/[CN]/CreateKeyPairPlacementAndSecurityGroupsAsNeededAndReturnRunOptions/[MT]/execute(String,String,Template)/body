{
  checkArgument(template.getHardware() instanceof EC2Hardware,"unexpected image type. should be EC2Size, was: " + template.getHardware().getClass());
  EC2Hardware ec2Size=EC2Hardware.class.cast(template.getHardware());
  RunInstancesOptions instanceOptions=asType(ec2Size.getInstanceType()).withAdditionalInfo(tag);
  String keyPairName=createNewKeyPairUnlessUserSpecifiedOtherwise(region,tag,template.getOptions());
  String placementGroupName=ec2Size.getId().startsWith("cc") ? createNewPlacementGroupUnlessUserSpecifiedOtherwise(region,tag,template.getOptions()) : null;
  String subnetId=EC2TemplateOptions.class.cast(template.getOptions()).getSubnetId();
  if (subnetId != null) {
    instanceOptions.withSubnetId(subnetId);
  }
 else {
    Set<String> groups=getSecurityGroupsForTagAndOptions(region,tag,template.getOptions());
    instanceOptions.withSecurityGroups(groups);
  }
  if (keyPairName != null)   instanceOptions.withKeyName(keyPairName);
  if (placementGroupName != null)   instanceOptions.inPlacementGroup(placementGroupName);
  return instanceOptions;
}
