{
  GoGridClient caller=createMock(GoGridClient.class);
  GridServerClient client=createMock(GridServerClient.class);
  expect(caller.getServerServices()).andReturn(client).atLeastOnce();
  Map<String,NodeState> serverStateToNodeState=createMock(Map.class);
  org.jclouds.compute.domain.Image jcImage=createMock(org.jclouds.compute.domain.Image.class);
  Option dc=new Option(1l,"US-West-1","US West 1 Datacenter");
  Set<org.jclouds.compute.domain.Image> images=ImmutableSet.of(jcImage);
  Server server=createMock(Server.class);
  expect(server.getId()).andReturn(1000l).atLeastOnce();
  expect(server.getName()).andReturn("tag-ff").atLeastOnce();
  expect(server.getState()).andReturn(new Option("NODE_RUNNING")).atLeastOnce();
  expect(serverStateToNodeState.get("NODE_RUNNING")).andReturn(NodeState.RUNNING);
  LocationImpl location=new LocationImpl(LocationScope.ZONE,"1","US-West-1",null);
  Map<String,? extends Location> locations=ImmutableMap.<String,Location>of("1",location);
  Map<String,Credentials> credentialsMap=createMock(Map.class);
  expect(client.getServerCredentialsList()).andReturn(credentialsMap);
  expect(credentialsMap.get("tag-ff")).andReturn(new Credentials("user","pass"));
  expect(server.getIp()).andReturn(new Ip("127.0.0.1"));
  ServerImage image=createMock(ServerImage.class);
  expect(server.getImage()).andReturn(image).atLeastOnce();
  expect(server.getDatacenter()).andReturn(dc).atLeastOnce();
  expect(image.getId()).andReturn(2000l).atLeastOnce();
  expect(jcImage.getProviderId()).andReturn("2000").atLeastOnce();
  expect(jcImage.getLocation()).andReturn(location).atLeastOnce();
  replay(caller);
  replay(client);
  replay(serverStateToNodeState);
  replay(server);
  replay(image);
  replay(jcImage);
  replay(credentialsMap);
  ServerToNodeMetadata parser=new ServerToNodeMetadata(serverStateToNodeState,caller,images,locations);
  NodeMetadata metadata=parser.apply(server);
  assertEquals(metadata.getLocation(),location);
  assertEquals(metadata.getImage(),jcImage);
  assertEquals(metadata.getTag(),"tag");
  assertEquals(metadata.getCredentials(),new Credentials("user","pass"));
  verify(caller);
  verify(client);
  verify(serverStateToNodeState);
  verify(image);
  verify(credentialsMap);
  verify(server);
  verify(jcImage);
}
