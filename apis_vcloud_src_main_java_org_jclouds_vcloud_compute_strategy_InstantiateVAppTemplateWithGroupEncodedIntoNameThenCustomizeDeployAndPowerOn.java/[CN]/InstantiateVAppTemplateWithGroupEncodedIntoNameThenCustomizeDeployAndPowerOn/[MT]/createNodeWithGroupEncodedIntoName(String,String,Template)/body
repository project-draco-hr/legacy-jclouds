{
  InstantiateVAppTemplateOptions options=processorCount((int)getCores(template.getHardware())).memory(template.getHardware().getRam()).disk((long)((template.getHardware().getVolumes().get(0).getSize()) * 1024 * 1024l));
  String customizationScript=null;
  IpAddressAllocationMode ipAddressAllocationMode=null;
  if (template.getOptions() instanceof VCloudTemplateOptions) {
    customizationScript=VCloudTemplateOptions.class.cast(template.getOptions()).getCustomizationScript();
    ipAddressAllocationMode=VCloudTemplateOptions.class.cast(template.getOptions()).getIpAddressAllocationMode();
    if (customizationScript != null || ipAddressAllocationMode != null) {
      options.customizeOnInstantiate(false);
      options.deploy(false);
      options.powerOn(false);
    }
  }
  if (!template.getOptions().shouldBlockUntilRunning())   options.block(false);
  URI VDC=URI.create(template.getLocation().getId());
  URI templateId=URI.create(template.getImage().getId());
  logger.debug(">> instantiating vApp vDC(%s) template(%s) name(%s) options(%s) ",VDC,templateId,name,options);
  VApp vAppResponse=client.instantiateVAppTemplateInVDC(VDC,templateId,name,options);
  logger.debug("<< instantiated VApp(%s)",vAppResponse.getName());
  Task task=vAppResponse.getTasks().get(0);
  if (customizationScript == null && ipAddressAllocationMode == null) {
    return blockOnDeployAndPowerOnIfConfigured(options,vAppResponse,task);
  }
 else {
    if (!successTester.apply(task.getHref())) {
      throw new RuntimeException(String.format("failed to %s %s: %s","instantiate",vAppResponse.getName(),task));
    }
    Vm vm=Iterables.get(client.getVApp(vAppResponse.getHref()).getChildren(),0);
    if (customizationScript != null)     updateVmWithCustomizationScript(vm,customizationScript);
    if (ipAddressAllocationMode != null)     updateVmWithIpAddressAllocationMode(vm,ipAddressAllocationMode);
    task=client.deployAndPowerOnVAppOrVm(vAppResponse.getHref());
    return blockOnDeployAndPowerOnIfConfigured(options,vAppResponse,task);
  }
}
