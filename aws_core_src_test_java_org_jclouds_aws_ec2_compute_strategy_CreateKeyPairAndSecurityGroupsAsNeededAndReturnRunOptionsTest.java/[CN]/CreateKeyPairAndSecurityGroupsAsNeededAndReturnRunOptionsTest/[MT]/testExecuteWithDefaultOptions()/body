{
  String region=Region.AP_SOUTHEAST_1;
  String tag="tag";
  EC2Size size=EC2Size.M1_SMALL;
  String systemGeneratedKeyPairName="systemGeneratedKeyPair";
  String generatedGroup="group";
  Set<String> generatedGroups=ImmutableSet.of(generatedGroup);
  CreateKeyPairAndSecurityGroupsAsNeededAndReturnRunOptions strategy=createMock(CreateKeyPairAndSecurityGroupsAsNeededAndReturnRunOptions.class,new Method[]{CreateKeyPairAndSecurityGroupsAsNeededAndReturnRunOptions.class.getDeclaredMethod("createNewKeyPairUnlessUserSpecifiedOtherwise",String.class,String.class,EC2TemplateOptions.class),CreateKeyPairAndSecurityGroupsAsNeededAndReturnRunOptions.class.getDeclaredMethod("getSecurityGroupsForTagAndOptions",String.class,String.class,EC2TemplateOptions.class)});
  EC2TemplateOptions options=createMock(EC2TemplateOptions.class);
  Template template=createMock(Template.class);
  expect(template.getSize()).andReturn(size).atLeastOnce();
  expect(template.getOptions()).andReturn(options).atLeastOnce();
  expect(strategy.createNewKeyPairUnlessUserSpecifiedOtherwise(region,tag,options)).andReturn(systemGeneratedKeyPairName);
  expect(strategy.getSecurityGroupsForTagAndOptions(region,tag,options)).andReturn(generatedGroups);
  replay(options);
  replay(template);
  replay(strategy);
  RunInstancesOptions runOptions=strategy.execute(region,tag,template);
  assertEquals(runOptions.buildQueryParameters(),ImmutableMultimap.<String,String>of());
  assertEquals(runOptions.buildFormParameters().entries(),ImmutableMultimap.<String,String>of("InstanceType",size.getProviderId(),"SecurityGroup.1",generatedGroup,"AdditionalInfo",tag,"KeyName",systemGeneratedKeyPairName).entries());
  assertEquals(runOptions.buildMatrixParameters(),ImmutableMultimap.<String,String>of());
  assertEquals(runOptions.buildRequestHeaders(),ImmutableMultimap.<String,String>of());
  assertEquals(runOptions.buildStringPayload(),null);
  verify(options);
  verify(template);
  verify(strategy);
}
