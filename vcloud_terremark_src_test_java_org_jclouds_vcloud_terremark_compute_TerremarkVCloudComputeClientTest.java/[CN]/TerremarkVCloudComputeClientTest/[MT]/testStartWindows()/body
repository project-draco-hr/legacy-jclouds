{
  InputStream is=getClass().getResourceAsStream("/terremark/windows_description.txt");
  String description=new String(ByteStreams.toByteArray(is));
  VAppTemplate template=createMock(VAppTemplate.class);
  expect(template.getDescription()).andReturn(description).atLeastOnce();
  TerremarkVCloudClient client=createMock(TerremarkVCloudClient.class);
  expect(client.getVAppTemplate("templateId")).andReturn(template);
  VApp vApp=createMock(VApp.class);
  expect(client.instantiateVAppTemplateInVDC("vDCId","name","templateId",new TerremarkInstantiateVAppTemplateOptions().productProperty("password","password"))).andReturn(vApp);
  Task task=createMock(Task.class);
  expect(vApp.getId()).andReturn("1").atLeastOnce();
  expect(client.getVAppTemplate("templateId")).andReturn(template);
  expect(client.deployVApp("1")).andReturn(task);
  expect(task.getId()).andReturn("1").atLeastOnce();
  Predicate<String> successTester=createMock(Predicate.class);
  expect(successTester.apply("1")).andReturn(true).atLeastOnce();
  expect(client.powerOnVApp("1")).andReturn(task);
  Predicate<VApp> notFoundTester=createMock(Predicate.class);
  Map<VAppStatus,NodeState> vAppStatusToNodeState=createMock(Map.class);
  TerremarkVCloudComputeClient computeClient=new TerremarkVCloudComputeClient(client,new ParseVAppTemplateDescriptionToGetDefaultLoginCredentials(),new Provider<String>(){
    @Override public String get(){
      return "password";
    }
  }
,successTester,notFoundTester,vAppStatusToNodeState);
  replay(template);
  replay(vApp);
  replay(task);
  replay(client);
  replay(successTester);
  replay(notFoundTester);
  replay(vAppStatusToNodeState);
  Map<String,String> response=computeClient.start("vDCId","name","templateId",new TerremarkInstantiateVAppTemplateOptions());
  assertEquals(response.get("id"),"1");
  assertEquals(response.get("username"),"Administrator");
  assertEquals(response.get("password"),"password");
  verify(template);
  verify(vApp);
  verify(task);
  verify(client);
  verify(successTester);
  verify(notFoundTester);
  verify(vAppStatusToNodeState);
}
