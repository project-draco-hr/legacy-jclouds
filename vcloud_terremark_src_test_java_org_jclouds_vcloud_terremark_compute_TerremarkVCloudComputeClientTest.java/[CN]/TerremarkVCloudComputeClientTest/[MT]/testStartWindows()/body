{
  InputStream is=getClass().getResourceAsStream("/terremark/windows_description.txt");
  String description=new String(ByteStreams.toByteArray(is));
  VCloudExpressVAppTemplate template=createMock(VCloudExpressVAppTemplate.class);
  TerremarkVDC vdc=createMock(TerremarkVDC.class);
  URI templateURI=URI.create("template");
  URI vdcURI=URI.create("vdc");
  expect(template.getDescription()).andReturn(description).atLeastOnce();
  TerremarkVCloudExpressClient client=createMock(TerremarkVCloudExpressClient.class);
  VCloudExpressVApp vApp=createMock(VCloudExpressVApp.class);
  expect(client.getVDC(vdcURI)).andReturn(vdc);
  expect(client.getVAppTemplate(templateURI)).andReturn(template);
  expect(client.getVAppTemplate(templateURI)).andReturn(template);
  expect(vdc.getId()).andReturn(vdcURI);
  expect(template.getId()).andReturn(templateURI);
  expect(client.instantiateVAppTemplateInVDC(vdcURI,templateURI,"name",new TerremarkInstantiateVAppTemplateOptions().productProperty("password","password"))).andReturn(vApp);
  Task task=createMock(Task.class);
  URI vappLocation=URI.create("vapp");
  URI taskLocation=URI.create("task");
  expect(vApp.getId()).andReturn(vappLocation).atLeastOnce();
  expect(vApp.getName()).andReturn("name").atLeastOnce();
  expect(client.deployVApp(vappLocation)).andReturn(task);
  expect(task.getId()).andReturn(taskLocation).atLeastOnce();
  Predicate<URI> successTester=createMock(Predicate.class);
  expect(successTester.apply(taskLocation)).andReturn(true).atLeastOnce();
  expect(client.powerOnVApp(vappLocation)).andReturn(task);
  Predicate<VCloudExpressVApp> notFoundTester=createMock(Predicate.class);
  Map<Status,NodeState> vAppStatusToNodeState=createMock(Map.class);
  TerremarkVCloudComputeClient computeClient=new TerremarkVCloudComputeClient(client,new ParseVAppTemplateDescriptionToGetDefaultLoginCredentials(),new Provider<String>(){
    @Override public String get(){
      return "password";
    }
  }
,successTester,vAppStatusToNodeState);
  replay(vdc);
  replay(template);
  replay(vApp);
  replay(task);
  replay(client);
  replay(successTester);
  replay(notFoundTester);
  replay(vAppStatusToNodeState);
  Map<String,String> response=computeClient.start(vdcURI,templateURI,"name",new TerremarkInstantiateVAppTemplateOptions());
  assertEquals(response.get("id"),"vapp");
  assertEquals(response.get("username"),"Administrator");
  assertEquals(response.get("password"),"password");
  verify(vdc);
  verify(template);
  verify(vApp);
  verify(task);
  verify(client);
  verify(successTester);
  verify(notFoundTester);
  verify(vAppStatusToNodeState);
}
