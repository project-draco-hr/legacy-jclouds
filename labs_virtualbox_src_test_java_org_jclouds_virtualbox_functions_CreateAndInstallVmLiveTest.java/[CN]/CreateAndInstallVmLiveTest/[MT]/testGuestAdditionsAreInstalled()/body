{
  try {
    IMachine machine=cloneFromMaster();
    machineController.ensureMachineIsLaunched(machine.getName());
    sshClientForIMachine=injector.getInstance(IMachineToSshClient.class);
    SshClient client=sshClientForIMachine.apply(machine);
    sshResponds=injector.getInstance(SshResponds.class);
    checkState(sshResponds.apply(client),"timed out waiting for guest %s to be accessible via ssh",machine.getName());
    String version=machineUtils.sharedLockMachineAndApplyToSession(machine.getName(),new Function<ISession,String>(){
      @Override public String apply(      ISession session){
        return session.getMachine().getGuestPropertyValue("/VirtualBox/GuestAdd/Version");
      }
    }
);
    assertTrue(version != null && !version.isEmpty());
  }
  finally {
    for (    VmSpec spec : ImmutableSet.of(machineSpec.getVmSpec())) {
      machineController.ensureMachineIsShutdown(spec.getVmName());
    }
  }
}
