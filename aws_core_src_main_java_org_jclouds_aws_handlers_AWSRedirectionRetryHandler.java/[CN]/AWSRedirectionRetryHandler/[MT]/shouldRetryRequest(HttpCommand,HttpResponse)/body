{
  if (response.getFirstHeaderOrNull(HttpHeaders.LOCATION) == null && (response.getStatusCode() == 301 || response.getStatusCode() == 307)) {
    byte[] content=closeClientButKeepContentStream(response);
    if (command.getRequest().getMethod() == HttpMethod.HEAD) {
      changeToGETRequest(command.getRequest());
      return true;
    }
 else {
      command.incrementRedirectCount();
      try {
        AWSError error=utils.parseAWSErrorFromContent(command.getRequest(),response,new String(content));
        String host=error.getDetails().get("Endpoint");
        if (host != null) {
          if (host.equals(command.getRequest().getEndpoint().getHost())) {
            return backoffHandler.shouldRetryRequest(command,response);
          }
 else {
            changeSchemeHostAndPortTo(command.getRequest(),command.getRequest().getEndpoint().getScheme(),host,command.getRequest().getEndpoint().getPort(),uriBuilderProvider.get());
          }
          return true;
        }
 else {
          return false;
        }
      }
 catch (      HttpException e) {
        logger.error(e,"error on redirect for command %s; response %s; retrying...",command,response);
        return false;
      }
    }
  }
 else {
    return super.shouldRetryRequest(command,response);
  }
}
