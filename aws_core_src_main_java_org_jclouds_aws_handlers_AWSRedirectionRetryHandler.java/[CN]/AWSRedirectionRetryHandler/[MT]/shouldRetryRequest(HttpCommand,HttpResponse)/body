{
  if (response.getFirstHeaderOrNull(HttpHeaders.LOCATION) == null && (response.getStatusCode() == 301 || response.getStatusCode() == 307)) {
    if (command.getCurrentRequest().getMethod() == HttpMethod.HEAD) {
      command.setCurrentRequest(command.getCurrentRequest().toBuilder().method("GET").build());
      return true;
    }
 else {
      command.incrementRedirectCount();
      closeClientButKeepContentStream(response);
      AWSError error=utils.parseAWSErrorFromContent(command.getCurrentRequest(),response);
      String host=error.getDetails().get("Endpoint");
      if (host != null) {
        if (host.equals(command.getCurrentRequest().getEndpoint().getHost())) {
          return backoffHandler.shouldRetryRequest(command,response);
        }
 else {
          UriBuilder builder=uriBuilderProvider.get().uri(command.getCurrentRequest().getEndpoint());
          builder.host(host);
          command.setCurrentRequest(command.getCurrentRequest().toBuilder().endpoint(builder.build()).build());
        }
        return true;
      }
 else {
        return false;
      }
    }
  }
 else {
    return super.shouldRetryRequest(command,response);
  }
}
