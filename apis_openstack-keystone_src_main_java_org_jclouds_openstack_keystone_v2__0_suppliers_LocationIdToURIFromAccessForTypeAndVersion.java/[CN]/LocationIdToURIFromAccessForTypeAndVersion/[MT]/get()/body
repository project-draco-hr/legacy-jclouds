{
  Access accessResponse=access.get();
  Set<Service> services=Sets.filter(accessResponse.getServiceCatalog(),new Predicate<Service>(){
    @Override public boolean apply(    Service input){
      return input.getType().equals(apiType);
    }
  }
);
  if (services.size() == 0)   throw new NoSuchElementException(String.format("apiType %s not found in catalog %s",apiType,accessResponse.getServiceCatalog()));
  Iterable<Endpoint> endpoints=Iterables.filter(Iterables.concat(services),new Predicate<Endpoint>(){
    @Override public boolean apply(    Endpoint input){
      if (input.getVersionId() == null) {
        return true;
      }
      return input.getVersionId().equals(apiVersion);
    }
  }
);
  if (Iterables.size(endpoints) == 0)   throw new NoSuchElementException(String.format("no endpoints for apiType %s are of version %s, or version agnostic: %s",apiType,apiVersion,services));
  Map<String,Endpoint> locationIdToEndpoint=Maps.uniqueIndex(endpoints,endpointToLocationId);
  return Maps.transformValues(locationIdToEndpoint,endpointToSupplierURI);
}
