{
  Long slotId=0l;
  IMachine machine=createMock(IMachine.class);
  INetworkAdapter networkAdapter=createMock(INetworkAdapter.class);
  INATEngine natEngine=createMock(INATEngine.class);
  expect(machine.getNetworkAdapter(slotId)).andReturn(networkAdapter);
  networkAdapter.setAttachmentType(NAT);
  expect(networkAdapter.getNatDriver()).andReturn(natEngine);
  natEngine.addRedirect("TCP@127.0.0.1:2222->:22",TCP,"127.0.0.1",2222,"",22);
  expectLastCall().andThrow(new VBoxException(null,"VirtualBox error: A NAT rule of this name already exists (0x80070057)"));
  networkAdapter.setEnabled(true);
  machine.saveSettings();
  replay(machine,networkAdapter,natEngine);
  NatAdapter natAdapter=NatAdapter.builder().tcpRedirectRule("127.0.0.1",2222,"",22).build();
  new AttachNATAdapterToMachineIfNotAlreadyExists(slotId,natAdapter).apply(machine);
  verify(machine,networkAdapter,natEngine);
}
